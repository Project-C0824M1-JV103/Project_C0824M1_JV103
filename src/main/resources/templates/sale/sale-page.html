<!DOCTYPE html>
<html
        lang="en"
        xmlns:th="http://www.thymeleaf.org"
        xmlns="http://www.w3.org/1999/html"
>
<head>
    <meta charset="UTF-8"/>
    <title>Quản lý bán hàng</title>

    <!-- Bootstrap CSS -->
    <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
            rel="stylesheet"
    />
    <!-- Bootstrap Icons -->
    <link
            rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css"
    />
    <!-- Font Awesome -->
    <link
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
            rel="stylesheet"
    />
    <link rel="stylesheet" th:href="@{/admin-navbar.css}">
    <link rel="stylesheet" th:href="@{/admin-common.css}">

    <style>
        .main-content {
            background-color: #f8f9fa;
            min-height: 100vh;
        }

        .header-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .search-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px;
            font-weight: 600;
            text-align: center;
        }

        .table td {
            padding: 15px;
            vertical-align: middle;
            border-bottom: 1px solid #eee;
            text-align: center;
        }

        .table tbody tr:hover {
            background-color: #f8f9fa;
            transition: all 0.3s ease;
        }

        body.modal-open {
            overflow: hidden;
            padding-right: 0;
        }

        .modal.show .modal-dialog {
            transform: none;
        }

        .modal.fade .modal-dialog {
            transition: transform 0.3s ease-out;
            transform: translate(0, -50px);
        }

        .modal.show .modal-dialog {
            transform: none;
        }

        /* Button hover effects */
        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .modal-header .btn-close {
            filter: invert(1);
        }

        .form-label {
            font-weight: 500;
        }

        .form-control,
        .form-select {
            border-radius: 0.5rem;
            padding: 10px 12px;
            border: 1px solid #ced4da;
            transition: border-color 0.3s ease-in-out, box-shadow 0.3s;
        }

        .form-control:focus,
        .form-select:focus {
            border-color: #86b7fe;
            box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
        }

        .section-title {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px;
            font-weight: 600;
            text-align: center;
            border-radius: 0.5rem;
            margin-bottom: 20px;
        }

        .form-control[readonly] {
            background-color: #e9ecef;
            cursor: not-allowed;
            opacity: 0.8;
        }

        .form-control[readonly]:focus {
            box-shadow: none;
            border-color: #ced4da;
        }
        /* Loading overlay styles (copied from add-supplier-form.html) */
        .admin-loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(102,126,234,0.15); /* subtle blue, like add-supplier-form */
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
        }
        .admin-loading-box {
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 4px 32px rgba(102,126,234,0.15);
            padding: 40px 60px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .admin-spinner {
            margin-bottom: 16px;
        }
        .admin-loading-text {
            font-size: 1.2rem;
            color: #667eea;
            font-weight: 600;
        }
    </style>
</head>
<body>
<div class="container-fluid">
    <div class="row">
        <!-- Include Admin Navbar -->
        <div th:replace="~{navbar/admin-navbar :: admin-sidebar}"></div>

        <!-- Main Content -->
        <div class="col-md-9 col-lg-10">
            <div class="main-content p-4">
                <!-- Header Section -->
                <div class="header-section">
                    <div class="row align-items-center">
                        <div class="col">
                            <h2 class="mb-1">
                                <i class="fas fa-chart-line text-primary"></i>
                                Quản lý bán hàng
                            </h2>
                            <p class="text-muted mb-0">
                                Thông tin bán hàng
                            </p>
                        </div>
                    </div>
                </div>

                <div class="search-section">
                    <h4 class="section-title">
                        <i class="fas fa-shopping-cart"></i> Bán hàng</h4>
                    <form th:action="@{/Sale/create}" th:object="${saleDto}" method="post" id="saleForm">
                        <input type="hidden" name="employeeName"
                               th:value="${currentUser != null ? currentUser.email : ''}">
                        <!-- Thông tin khách hàng -->
                        <fieldset class="mb-4 p-3 border rounded">
                            <legend class="w-auto px-2">Thông tin khách hàng</legend>
                            <div class="row mb-3 g-2">
                                <div class="col-md-4">
                                    <button type="button" class="btn btn-outline-primary w-100" data-bs-toggle="modal"
                                            data-bs-target="#customerModal">Chọn khách hàng cũ
                                    </button>
                                </div>
                            </div>
                            <div class="row g-2 mb-2">
                                <div class="col-md-6">
                                    <label class="form-label mb-1">Họ và tên</label>
                                    <input type="text" class="form-control customer-input" name="customerName"
                                           th:field="*{customerName}"
                                           th:classappend="${#fields.hasErrors('customerName')} ? 'is-invalid'"/>
                                    <div class="invalid-feedback" th:if="${#fields.hasErrors('customerName')}"
                                         th:errors="*{customerName}"></div>
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label mb-1">Địa chỉ</label>
                                    <input type="text" class="form-control customer-input" name="address"
                                           th:field="*{address}"
                                           th:classappend="${#fields.hasErrors('address')} ? 'is-invalid'"/>
                                    <div class="invalid-feedback" th:if="${#fields.hasErrors('address')}"
                                         th:errors="*{address}"></div>
                                </div>

                                <div class="col-md-4">
                                    <label class="form-label mb-1">Số điện thoại</label>
                                    <input type="text" class="form-control customer-input" name="phoneNumber"
                                           th:field="*{phoneNumber}"
                                           th:classappend="${#fields.hasErrors('phoneNumber')} ? 'is-invalid'"/>
                                    <div class="invalid-feedback" th:if="${#fields.hasErrors('phoneNumber')}"
                                         th:errors="*{phoneNumber}"></div>
                                    <div class="client-validation-feedback invalid-feedback" style="display:none;"></div>
                                </div>

                                <div class="col-md-4">
                                    <label class="form-label mb-1">E-mail</label>
                                    <div class="input-group">
                                        <input type="email" class="form-control customer-input" name="email"
                                               th:field="*{email}"
                                               th:classappend="${#fields.hasErrors('email')} ? 'is-invalid'"/>
                                        <button type="button" class="btn btn-outline-secondary" id="verifyEmailBtn" style="display:none;">Verify</button>
                                        <button type="button" class="btn btn-success" id="verifiedEmailBtn" style="display:none;" disabled>
                                            <i class="fas fa-check"></i> Verified
                                        </button>
                                    </div>
                                    <div class="invalid-feedback" th:if="${#fields.hasErrors('email')}"
                                         th:errors="*{email}"></div>
                                </div>

                                <div class="col-md-4">
                                    <label class="form-label mb-1">Ngày sinh</label>
                                    <input type="date" class="form-control customer-input" name="birthdayDate"
                                           th:field="*{birthdayDate}"
                                           th:classappend="${#fields.hasErrors('birthdayDate')} ? 'is-invalid'"/>
                                    <div class="invalid-feedback" th:if="${#fields.hasErrors('birthdayDate')}"
                                         th:errors="*{birthdayDate}"></div>
                                </div>
                            </div>
                            <div class="row mt-2">
                                <div class="col-12">
                                    <button type="button" class="btn btn-outline-danger" id="resetCustomerBtn"
                                            style="display: none;">
                                        <i class="fas fa-undo"></i> Nhập lại thông tin khách hàng
                                    </button>
                                </div>
                            </div>
                        </fieldset>
                        <!-- Thông tin sản phẩm -->
                        <fieldset class="mb-4 p-3 border rounded">
                            <legend class="w-auto px-2">Thông tin sản phẩm</legend>
                            <div class="row g-2 mb-2">
                                <div class="col-md-4">
                                    <button type="button" class="btn btn-outline-primary w-100" data-bs-toggle="modal"
                                            data-bs-target="#productModal">Chọn sản phẩm
                                    </button>
                                </div>
                                <div class="col-md-8"></div>
                            </div>
                            <div class="row g-2 mb-2">
                                <div class="col-md-6">
                                    <label class="form-label mb-1">Tên sản phẩm</label>
                                    <input type="text" class="form-control" id="selectedProductName" readonly/>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label mb-1">Đơn giá (VND)</label>
                                    <input type="number" class="form-control" min="0" id="selectedProductPrice"
                                           readonly/>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label mb-1">Số lượng</label>
                                    <input type="number" class="form-control" min="1" id="selectedProductQuantity"
                                           value="1"/>
                                    <div id="quantityError" class="invalid-feedback" style="display:none;"></div>
                                </div>
                            </div>
                            <div class="row g-2 mb-2">
                                <div class="col-md-4">
                                    <button type="button" class="btn btn-outline-success w-100"
                                            onclick="addProductToTable()">
                                        <i class="fas fa-plus"></i> Thêm sản phẩm
                                    </button>
                                </div>
                            </div>
                            <div class="row g-2 mb-2">
                                <div class="col-12">
                                    <table id="selectedProductsTable" class="table table-bordered align-middle">
                                        <thead>
                                        <tr>
                                            <th>Tên sản phẩm</th>
                                            <th>Đơn giá (VNĐ)</th>
                                            <th>Số lượng</th>
                                            <th>Thành tiền (VNĐ)</th>
                                            <th>Thao tác</th>
                                        </tr>
                                        </thead>
                                        <tbody>
                                        <!-- Dòng sản phẩm sẽ được thêm ở đây bằng JS -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </fieldset>
                        <!-- Thanh toán -->
                        <div class="row g-2 mb-2 align-items-center">
                            <div class="col-md-2">
                                <label class="form-label mb-1">Thành tiền</label>
                            </div>
                            <div class="col-md-6">
                                <input type="text" class="form-control" th:field="*{amount}" readonly/>
                            </div>
                            <div class="col-md-2 d-flex align-items-end">VNĐ</div>
                        </div>
                        <div class="row g-2 mb-2 align-items-center">
                            <div class="col-md-3">
                                <label class="form-label mb-1">Hình thức thanh toán</label>
                            </div>
                            <div class="col-md-9 d-flex align-items-center gap-3">
                                <div class="form-check me-3 d-flex align-items-center">
                                    <input class="form-check-input" type="radio" name="paymentMethod" id="vnpay"
                                           th:field="*{paymentMethod}" value="VNPAY"/>
                                    <label class="form-check-label d-flex align-items-center ms-2" for="vnpay">
                                        <img src="https://stcd02206177151.cloud.edgevnpay.vn/assets/images/logo-icon/logo-primary.svg"
                                             alt="VNPay"
                                             style="height:24px;width:auto;object-fit:contain;margin-right:6px;">
                                    </label>
                                </div>

                                <div class="form-check d-flex align-items-center">
                                    <input class="form-check-input" type="radio" name="paymentMethod" id="cash"
                                           th:field="*{paymentMethod}" value="CASH"/>
                                    <label class="form-check-label d-flex align-items-center ms-2" for="cash">
                                        Tiền mặt <i class="fa-solid fa-money-bill-wave fa-lg me-1"
                                                    style="color:#28a745;"></i>
                                    </label>
                                </div>
                                <p class="text-danger" th:if="${#fields.hasErrors('paymentMethod')}"
                                   th:errors="*{paymentMethod}"></p>
                            </div>
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="invoice" th:field="*{printPDF}"
                                   checked/>
                            <label class="form-check-label" for="invoice">In hóa đơn</label>
                        </div>
                        <div class="text-center mt-4">
                            <button type="submit" class="btn btn-primary">Tiến hành thanh toán</button>
                            <a th:href="@{/Sale}" class="btn btn-secondary ms-2"> <i class="fas fa-refresh"></i> Làm mới</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- Modal chọn khách hàng -->
<div class="modal fade" id="customerModal" tabindex="-1" aria-labelledby="customerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="customerModalLabel">Chọn khách hàng</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
            </div>
            <div class="modal-body">
                <!-- Form tìm kiếm -->
                <form id="customerSearchForm" class="mb-4">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <div class="input-group">
                <span class="input-group-text">
                  <i class="fas fa-user"></i>
                </span>
                                <input type="text" name="customerName" class="form-control"
                                       placeholder="Tìm kiếm theo tên khách hàng..."
                                       th:value="${customerName}"/>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="input-group">
                <span class="input-group-text">
                  <i class="fas fa-phone"></i>
                </span>
                                <input type="text" name="phoneNumber" class="form-control"
                                       placeholder="Tìm kiếm theo số điện thoại..."
                                       th:value="${phoneNumber}"/>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <button type="button" class="btn btn-primary w-100" onclick="searchCustomers()">
                                <i class="fas fa-search"></i> Tìm kiếm
                            </button>
                        </div>
                        <div class="col-md-2">
                            <button type="button" class="btn btn-outline-secondary w-100"
                                    onclick="refreshCustomerList()" title="Làm mới">
                                <i class="fas fa-sync-alt"></i> Làm mới
                            </button>
                        </div>
                    </div>
                    <!-- Hidden fields for pagination -->
                    <input type="hidden" name="page" value="0"/>
                    <input type="hidden" name="size" th:value="${pageSize}"/>
                </form>

                <!-- Bảng danh sách khách hàng -->
                <div id="customerTableContainer">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead>
                            <tr>
                                <th>Tên khách hàng</th>
                                <th>Số điện thoại</th>
                                <th>Email</th>
                                <th>Thao tác</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="customer,l : ${customers}">
                                <td>
                                    <div class="fw-bold" th:text="${customer.customerName}">Tên khách hàng</div>
                                </td>
                                <td>
                              <span th:text="${customer.phoneNumber ?: 'Chưa cập nhật'}">
                                  <i class="fas fa-phone text-muted me-1"></i>
                                  Chưa cập nhật
                              </span>
                                </td>
                                <td>
                              <span th:text="${customer.email ?: 'Chưa cập nhật'}">
                                  <i class="fas fa-envelope text-muted me-1"></i>
                                  Chưa cập nhật
                              </span>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary btn-select-customer"
                                            th:attr="data-customer-id=${customer.customerId}"
                                            title="Chọn khách hàng">
                                        <i class="fas fa-check"></i> Chọn
                                    </button>
                                </td>
                            </tr>
                            <!-- Empty state message -->
                            <tr th:if="${#lists.isEmpty(customers)}">
                                <td colspan="5" class="text-center py-4">
                                    <div class="text-muted">
                                        <i class="fas fa-users fa-2x mb-2"></i>
                                        <div th:if="${isSearch}">
                                            <h6>Không tìm thấy khách hàng nào</h6>
                                            <p class="mb-0">Thử thay đổi điều kiện tìm kiếm</p>
                                        </div>
                                        <div th:unless="${isSearch}">
                                            <h6>Chưa có khách hàng nào</h6>
                                            <p class="mb-0">Bắt đầu thêm khách hàng đầu tiên</p>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    <div class="d-flex justify-content-between align-items-center p-3 border-top mt-3">
                        <div class="text-muted">
                      <span th:if="${isSearch}">
                          Tìm thấy <span th:text="${totalElements}">0</span> khách hàng
                          <span th:if="${customerName != null && !customerName.isEmpty()}" class="text-primary">
                              với tên "<span th:text="${customerName}"></span>"
                          </span>
                          <span th:if="${phoneNumber != null && !phoneNumber.isEmpty()}" class="text-primary">
                              <span th:if="${customerName != null && !customerName.isEmpty()}">và</span>
                              với SĐT "<span th:text="${phoneNumber}"></span>"
                          </span>
                      </span>
                            <span th:unless="${isSearch}">
                          Hiển thị <span th:text="${#lists.size(customers)}">0</span> trên
                          <span th:text="${totalElements}">0</span> khách hàng
                      </span>
                        </div>

                        <!-- Pagination Controls -->
                        <nav th:if="${totalPages > 1}">
                            <ul class="pagination pagination-sm mb-0">
                                <!-- Previous Button -->
                                <li class="page-item" th:classappend="${pageNumber == 0} ? 'disabled'">
                                    <a class="page-link" href="javascript:void(0)"
                                       th:onclick="'changePage(' + ${pageNumber - 1} + ')'"
                                       th:unless="${pageNumber == 0}">
                                        <i class="fas fa-chevron-left"></i>
                                    </a>
                                    <span class="page-link" th:if="${pageNumber == 0}">
                                  <i class="fas fa-chevron-left"></i>
                              </span>
                                </li>

                                <!-- Page Numbers -->
                                <li class="page-item"
                                    th:each="i : ${#numbers.sequence(0, totalPages - 1)}"
                                    th:if="${i >= pageNumber - 2 && i <= pageNumber + 2}"
                                    th:classappend="${i == pageNumber} ? 'active'">
                                    <a class="page-link" href="javascript:void(0)"
                                       th:onclick="'changePage(' + ${i} + ')'"
                                       th:text="${i + 1}"
                                       th:unless="${i == pageNumber}">1</a>
                                    <span class="page-link" th:if="${i == pageNumber}" th:text="${i + 1}">1</span>
                                </li>

                                <!-- Next Button -->
                                <li class="page-item" th:classappend="${pageNumber >= totalPages - 1} ? 'disabled'">
                                    <a class="page-link" href="javascript:void(0)"
                                       th:onclick="'changePage(' + ${pageNumber + 1} + ')'"
                                       th:unless="${pageNumber >= totalPages - 1}">
                                        <i class="fas fa-chevron-right"></i>
                                    </a>
                                    <span class="page-link" th:if="${pageNumber >= totalPages - 1}">
                                  <i class="fas fa-chevron-right"></i>
                              </span>
                                </li>
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal chọn sản phẩm -->
<div class="modal fade" id="productModal" tabindex="-1" aria-labelledby="productModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="productModalLabel">Chọn sản phẩm</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
            </div>
            <div class="modal-body">
                <!-- Form tìm kiếm sản phẩm -->
                <form id="productSearchForm" class="mb-4">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="input-group">
                          <span class="input-group-text">
                              <i class="fas fa-mobile-alt"></i>
                          </span>
                                <input type="text" name="productName" class="form-control"
                                       placeholder="Tìm kiếm theo tên sản phẩm..."
                                       th:value="${productName}"/>
                            </div>
                        </div>

                        <div class="col-md-3">
                            <button type="button" class="btn btn-primary w-100" onclick="searchProducts()">
                                <i class="fas fa-search"></i> Tìm kiếm
                            </button>
                        </div>
                        <div class="col-md-3">
                            <button type="button" class="btn btn-outline-secondary w-100" onclick="refreshProductList()"
                                    title="Làm mới">
                                <i class="fas fa-sync-alt"></i> Làm mới
                            </button>
                        </div>
                    </div>
                    <!-- Hidden fields for pagination -->
                    <input type="hidden" name="page" value="0"/>
                    <input type="hidden" name="size" value="6"/>
                </form>

                <!-- Danh sách sản phẩm -->
                <div id="productTableContainer">
                    <div class="table-responsive" th:if="${products != null and !#lists.isEmpty(products.content)}">
                        <table class="table table-hover">
                            <thead>
                            <tr>
                                <th>Tên sản phẩm</th>
                                <th>Danh mục</th>
                                <th>Giá (VNĐ)</th>
                                <th>Số lượng</th>
                                <th>Thao tác</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="product : ${products.content}">
                                <td th:text="${product.productName}">Tên sản phẩm</td>
                                <td th:text="${product.categoryName}">Danh mục</td>
                                <td th:text="${#numbers.formatDecimal(product.price, 0, 'COMMA', 0, 'POINT')}">
                                    0 VNĐ
                                </td>
                                <td th:text="${product.quantity}">0</td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary btn-select-product"
                                            th:attr="data-product-id=${product.productId}"
                                            th:disabled="${product.quantity <= 0}">
                                        <i class="fas fa-plus"></i>
                                        <span th:text="${product.quantity > 0 ? 'Chọn' : 'Hết hàng'}">Chọn</span>
                                    </button>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Empty state -->
                    <div class="text-center py-4" th:if="${products == null or #lists.isEmpty(products.content)}">
                        <i class="fas fa-box fa-2x text-muted mb-3"></i>
                        <h6 class="text-muted">Không tìm thấy sản phẩm nào</h6>
                        <p class="text-muted mb-0">Thử thay đổi điều kiện tìm kiếm</p>
                    </div>

                    <!-- Pagination -->
                    <div class="d-flex justify-content-between align-items-center p-3 border-top mt-3"
                         th:if="${products != null and products.totalPages > 1}">
                        <div class="text-muted">
                            Hiển thị <span th:text="${#lists.size(products.content)}">0</span> trên
                            <span th:text="${products.totalElements}">0</span> sản phẩm
                        </div>

                        <!-- Pagination Controls -->
                        <nav>
                            <ul class="pagination pagination-sm mb-0">
                                <!-- Previous Button -->
                                <li class="page-item" th:classappend="${products.number == 0} ? 'disabled'">
                                    <a class="page-link" href="javascript:void(0)"
                                       th:onclick="'changeProductPage(' + ${products.number - 1} + ')'"
                                       th:unless="${products.number == 0}">
                                        <i class="fas fa-chevron-left"></i>
                                    </a>
                                    <span class="page-link" th:if="${products.number == 0}">
                                  <i class="fas fa-chevron-left"></i>
                              </span>
                                </li>

                                <!-- Page Numbers -->
                                <li class="page-item"
                                    th:each="i : ${#numbers.sequence(0, products.totalPages - 1)}"
                                    th:if="${i >= products.number - 2 && i <= products.number + 2}"
                                    th:classappend="${i == products.number} ? 'active'">
                                    <a class="page-link" href="javascript:void(0)"
                                       th:onclick="'changeProductPage(' + ${i} + ')'"
                                       th:text="${i + 1}"
                                       th:unless="${i == products.number}">1</a>
                                    <span class="page-link" th:if="${i == products.number}" th:text="${i + 1}">1</span>
                                </li>

                                <!-- Next Button -->
                                <li class="page-item"
                                    th:classappend="${products.number >= products.totalPages - 1} ? 'disabled'">
                                    <a class="page-link" href="javascript:void(0)"
                                       th:onclick="'changeProductPage(' + ${products.number + 1} + ')'"
                                       th:unless="${products.number >= products.totalPages - 1}">
                                        <i class="fas fa-chevron-right"></i>
                                    </a>
                                    <span class="page-link" th:if="${products.number >= products.totalPages - 1}">
                                  <i class="fas fa-chevron-right"></i>
                              </span>
                                </li>
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal nhập OTP xác thực email -->
<div class="modal fade" id="otpModal" tabindex="-1" aria-labelledby="otpModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="otpModalLabel">Xác thực Email</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
            </div>
            <div class="modal-body">
                <p>Mã OTP đã được gửi đến email của bạn. Vui lòng nhập mã OTP để xác thực.</p>
                <div class="mb-3">
                    <input type="text" class="form-control" id="otpInput" placeholder="Nhập mã OTP">
                    <div class="invalid-feedback" id="otpError" style="display:none;"></div>
                </div>
                <button type="button" class="btn btn-primary w-100" id="submitOtpBtn">Xác nhận</button>
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div class="admin-loading-overlay" id="loading-overlay">
  <div class="admin-loading-box">
    <div class="admin-spinner">
      <i class="fas fa-spinner fa-spin fa-2x"></i>
    </div>
    <div class="admin-loading-text">Đang xử lý, vui lòng chờ...</div>
  </div>
</div>

<script>
    function attachSelectCustomerEvents() {
        document.querySelectorAll('.btn-select-customer').forEach(btn => {
            btn.onclick = function () {
                const customerId = btn.getAttribute('data-customer-id');
                selectCustomer(customerId);
            }
        });
    }

    function updateCustomerTable(data) {
        const tbody = document.querySelector('#customerTableContainer tbody');
        const paginationInfo = document.querySelector('#customerTableContainer .d-flex.justify-content-between.align-items-center');

        // Update table content
        let tableContent = '';
        if (data.customers.length === 0) {
            tableContent = `
            <tr>
                <td colspan="5" class="text-center py-4">
                    <div class="text-muted">
                        <i class="fas fa-users fa-2x mb-2"></i>
                        <div>
                            <h6>${data.isSearch ? 'Không tìm thấy khách hàng nào' : 'Chưa có khách hàng nào'}</h6>
                            <p class="mb-0">${data.isSearch ? 'Thử thay đổi điều kiện tìm kiếm' : 'Bắt đầu thêm khách hàng đầu tiên'}</p>
                        </div>
                    </div>
                </td>
            </tr>`;
        } else {
            data.customers.forEach(customer => {
                tableContent += `
                <tr>
                    <td>
                        <div class="fw-bold">${customer.customerName}</div>
                    </td>
                    <td>
                        <span>${customer.phoneNumber || 'Chưa cập nhật'}</span>
                    </td>
                    <td>
                        <span>${customer.email || 'Chưa cập nhật'}</span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary btn-select-customer"
                                data-customer-id="${customer.customerId}"
                                title="Chọn khách hàng">
                            <i class="fas fa-check"></i> Chọn
                        </button>
                    </td>
                </tr>`;
            });
        }
        tbody.innerHTML = tableContent;

        // Update pagination info
        const infoContent = `
        <div class="text-muted">
            <span>
                Hiển thị ${data.customers.length} trên ${(data.totalElements !== undefined && data.totalElements !== null) ? data.totalElements : 0} khách hàng
            </span>
        </div>
        <nav ${data.totalPages > 1 ? '' : 'style="display:none"'}>
            <ul class="pagination pagination-sm mb-0">
                <li class="page-item ${data.pageNumber == 0 ? 'disabled' : ''}">
                    <a class="page-link" href="javascript:void(0)" 
                       onclick="changePage(${data.pageNumber - 1})"
                       ${data.pageNumber == 0 ? 'style="pointer-events:none"' : ''}>
                        <i class="fas fa-chevron-left"></i>
                    </a>
                </li>
                ${Array.from({length: data.totalPages}, (_, i) => i)
            .filter(i => i >= data.pageNumber - 2 && i <= data.pageNumber + 2)
            .map(i => `
                        <li class="page-item ${i == data.pageNumber ? 'active' : ''}">
                            <a class="page-link" href="javascript:void(0)"
                               onclick="changePage(${i})"
                               ${i == data.pageNumber ? 'style="pointer-events:none"' : ''}>
                                ${i + 1}
                            </a>
                        </li>
                    `).join('')}
                <li class="page-item ${data.pageNumber >= data.totalPages - 1 ? 'disabled' : ''}">
                    <a class="page-link" href="javascript:void(0)"
                       onclick="changePage(${data.pageNumber + 1})"
                       ${data.pageNumber >= data.totalPages - 1 ? 'style="pointer-events:none"' : ''}>
                        <i class="fas fa-chevron-right"></i>
                    </a>
                </li>
            </ul>
        </nav>`;
        paginationInfo.innerHTML = infoContent;

        // Reattach event listeners
        attachSelectCustomerEvents();
    }

    function searchCustomers() {
        const form = document.getElementById('customerSearchForm');
        const formData = new FormData(form);
        const params = new URLSearchParams(formData);

        // Reset page to 0 when searching
        params.set('page', '0');

        fetch(`/Sale/customers/data?${params.toString()}`)
            .then(response => response.json())
            .then(data => {
                updateCustomerTable(data);
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Có lỗi xảy ra khi tìm kiếm khách hàng!');
            });
    }

    function changePage(page) {
        const form = document.getElementById('customerSearchForm');
        const formData = new FormData(form);
        const params = new URLSearchParams(formData);

        // Keep the search parameters when changing page
        params.set('page', page);

        fetch(`/Sale/customers/data?${params.toString()}`)
            .then(response => response.json())
            .then(data => {
                updateCustomerTable(data);
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Có lỗi xảy ra khi chuyển trang!');
            });
    }

    function refreshCustomerList() {
        // Reset form search
        const form = document.getElementById('customerSearchForm');
        form.reset();

        // Load lại danh sách khách hàng ban đầu (trang 1, không có filter)
        fetch('/Sale/customers/data?page=0&size=6')
            .then(response => response.json())
            .then(data => {
                updateCustomerTable(data);
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Có lỗi xảy ra khi làm mới danh sách khách hàng!');
            });
    }

    // Product Modal Functions
    function updateProductTable(data) {
        const container = document.querySelector('#productTableContainer');

        let content = '';
        if (data.products.length === 0) {
            content = `
            <div class="text-center py-4">
                <i class="fas fa-box fa-2x text-muted mb-3"></i>
                <h6 class="text-muted">Không tìm thấy sản phẩm nào</h6>
                <p class="text-muted mb-0">Thử thay đổi điều kiện tìm kiếm</p>
            </div>`;
        } else {
            content = `
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Tên sản phẩm</th>
                            <th>Danh mục</th>
                            <th>Giá</th>
                            <th>Số lượng</th>
                            <th>Thao tác</th>
                        </tr>
                    </thead>
                    <tbody>`;

            data.products.forEach(product => {
                content += `
                <tr>
                    <td>${product.productName}</td>
                    <td>${product.categoryName || 'N/A'}</td>
                    <td>${new Intl.NumberFormat('en-US').format(product.price, 0, 'COMMA', 0, 'POINT') + ' VNĐ'}</td>
                    <td>${product.quantity}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary btn-select-product"
                                data-product-id="${product.productId}"
                                ${product.quantity <= 0 ? 'disabled' : ''}>
                            <i class="fas fa-plus"></i> 
                            ${product.quantity > 0 ? 'Chọn' : 'Hết hàng'}
                        </button>
                    </td>
                </tr>`;
            });

            content += `
                    </tbody>
                </table>
            </div>`;
        }

// Thêm phần pagination
        if (data.totalPages > 1) {
            content += `
                <div class="d-flex justify-content-between align-items-center p-3 border-top mt-3">
                    <div class="text-muted">
                        Hiển thị ${data.products.length} trên ${data.totalElements} sản phẩm
                    </div>
                    <nav>
                        <ul class="pagination pagination-sm mb-0">
                            <li class="page-item ${data.pageNumber == 0 ? 'disabled' : ''}">
                                <a class="page-link" href="javascript:void(0)"
                                   onclick="changeProductPage(${data.pageNumber - 1})"
                                   ${data.pageNumber == 0 ? 'style="pointer-events:none"' : ''}>
                                    <i class="fas fa-chevron-left"></i>
                                </a>
                            </li>`;
            for (let i = 0; i < data.totalPages; i++) {
                if (i >= data.pageNumber - 2 && i <= data.pageNumber + 2) {
                    content += `
                        <li class="page-item ${i == data.pageNumber ? 'active' : ''}">
                            <a class="page-link" href="javascript:void(0)"
                               onclick="changeProductPage(${i})"
                               ${i == data.pageNumber ? 'style="pointer-events:none"' : ''}>
                                ${i + 1}
                            </a>
                        </li>`;
                }
            }
            content += `
                            <li class="page-item ${data.pageNumber >= data.totalPages - 1 ? 'disabled' : ''}">
                                <a class="page-link" href="javascript:void(0)"
                                   onclick="changeProductPage(${data.pageNumber + 1})"
                                   ${data.pageNumber >= data.totalPages - 1 ? 'style="pointer-events:none"' : ''}>
                                    <i class="fas fa-chevron-right"></i>
                                </a>
                            </li>
                        </ul>
                    </nav>
                </div>`;
        }


        container.innerHTML = content;
        attachSelectProductEvents();
    }

    function searchProducts() {
        const form = document.getElementById('productSearchForm');
        const formData = new FormData(form);
        const params = new URLSearchParams(formData);
        params.set('page', '0');

        fetch(`/Sale/products/data?${params.toString()}`)
            .then(response => response.json())
            .then(data => updateProductTable(data))
            .catch(error => {
                console.error('Error:', error);
                alert('Có lỗi xảy ra khi tìm kiếm sản phẩm!');
            });
    }

    function changeProductPage(page) {
        const form = document.getElementById('productSearchForm');
        const formData = new FormData(form);
        const params = new URLSearchParams(formData);
        params.set('page', page);

        fetch(`/Sale/products/data?${params.toString()}`)
            .then(response => response.json())
            .then(data => updateProductTable(data))
            .catch(error => {
                console.error('Error:', error);
                alert('Có lỗi xảy ra khi chuyển trang!');
            });
    }

    function refreshProductList() {
        const form = document.getElementById('productSearchForm');
        form.reset();

        fetch('/Sale/products/data?page=0&size=6')
            .then(response => response.json())
            .then(data => updateProductTable(data))
            .catch(error => {
                console.error('Error:', error);
                alert('Có lỗi xảy ra khi làm mới danh sách sản phẩm!');
            });
    }

    function attachSelectProductEvents() {
        document.querySelectorAll('.btn-select-product').forEach(btn => {
            btn.onclick = function () {
                const productId = btn.getAttribute('data-product-id');
                selectProduct(productId);
            }
        });
    }

    // Danh sách sản phẩm đã chọn
    let selectedProducts = [];
    let currentProductStock = 0;

    function selectProduct(productId) {
        fetch(`/Sale/products/${productId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(product => {
                if (!product) {
                    throw new Error('Product data is empty');
                }
                // Điền thông tin vào form
                document.getElementById('selectedProductName').value = product.productName;
                document.getElementById('selectedProductPrice').value = product.price;
                document.getElementById('selectedProductQuantity').value = 1;
                currentProductStock = product.quantity;

                // Đóng modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('productModal'));
                modal.hide();
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Có lỗi xảy ra khi lấy thông tin sản phẩm!');
            });
    }

    // Kiểm tra số lượng nhập vào không vượt quá tồn kho
    function validateQuantityInput() {
        const quantityInput = document.getElementById('selectedProductQuantity');
        const quantity = parseInt(quantityInput.value) || 0;
        const errorDiv = document.getElementById('quantityError');
        const addBtn = document.querySelector('.btn-outline-success');

        if (quantity > currentProductStock) {
            quantityInput.classList.add('is-invalid');
            errorDiv.style.display = 'block';
            errorDiv.innerText = `Số lượng tồn kho chỉ còn ${currentProductStock}`;
            if (addBtn) addBtn.disabled = true;
        } else if (quantity <= 0) {
            quantityInput.classList.add('is-invalid');
            errorDiv.style.display = 'block';
            errorDiv.innerText = 'Số lượng phải lớn hơn 0';
            if (addBtn) addBtn.disabled = true;
        } else {
            quantityInput.classList.remove('is-invalid');
            errorDiv.style.display = 'none';
            errorDiv.innerText = '';
            if (addBtn) addBtn.disabled = false;
        }
    }

    function addProductToTable() {
        const name = document.getElementById('selectedProductName').value;
        const price = parseInt(document.getElementById('selectedProductPrice').value);
        const quantity = parseInt(document.getElementById('selectedProductQuantity').value);

        if (!name || !price || !quantity) {
            alert('Vui lòng chọn sản phẩm và nhập số lượng!');
            return;
        }

        if (quantity > currentProductStock) {
            alert(`Số lượng không thể vượt quá ${currentProductStock}!`);
            return;
        }

        if (quantity <= 0) {
            alert('Số lượng phải lớn hơn 0!');
            return;
        }

        // Kiểm tra trùng sản phẩm
        if (selectedProducts.some(p => p.productName === name)) {
            alert('Sản phẩm này đã có trong danh sách!');
            return;
        }

        const product = {
            productName: name,
            price: price,
            quantity: quantity,
            maxQuantity: currentProductStock
        };

        selectedProducts.push(product);
        renderSelectedProductsTable();

        // Reset form
        document.getElementById('selectedProductName').value = '';
        document.getElementById('selectedProductPrice').value = '';
        document.getElementById('selectedProductQuantity').value = '1';
        currentProductStock = 0;
    }

    function renderSelectedProductsTable() {
        const tbody = document.querySelector('#selectedProductsTable tbody');
        tbody.innerHTML = '';
        selectedProducts.forEach((product, index) => {
            const row = document.createElement('tr');
            row.innerHTML = `
            <td>${product.productName}</td>
            <td>${product.price.toLocaleString('en-US')}</td>
            <td>
                <input type="number"
                       min="1"
                       max="${product.maxQuantity}"
                       value="${product.quantity}"
                       class="form-control form-control-sm quantity-input"
                       style="width:80px;display:inline-block;"
                       onchange="updateProductQuantity(${index}, this.value)"/>
                <small class="text-muted">(Tối đa: ${product.maxQuantity})</small>
            </td>
            <td>${(product.price * product.quantity).toLocaleString('en-US')}</td>
            <td>
                <button type="button" class="btn btn-danger btn-sm" onclick="removeProduct(${index})">
                    <i class="fas fa-trash"></i> Xoá
                </button>
            </td>
        `;
            tbody.appendChild(row);
        });
        updateTotalAmount();
    }

    function updateProductQuantity(index, newQuantity) {
        const product = selectedProducts[index];
        const quantity = parseInt(newQuantity);

        if (isNaN(quantity) || quantity < 1) {
            alert('Số lượng không hợp lệ!');
            renderSelectedProductsTable();
            return;
        }

        if (quantity > product.maxQuantity) {
            alert(`Số lượng không thể vượt quá ${product.maxQuantity}!`);
            renderSelectedProductsTable();
            return;
        }

        product.quantity = quantity;
        renderSelectedProductsTable();
    }

    function removeProduct(index) {
        selectedProducts.splice(index, 1);
        renderSelectedProductsTable();
    }

    function updateTotalAmount() {
        const total = selectedProducts.reduce((sum, product) => {
            return sum + (product.price * product.quantity);
        }, 0);

        const amountInput = document.querySelector('input[name="amount"]');
        if (amountInput) {
            amountInput.value = total;
        }
    }

    // Add event listeners when document is loaded
    document.addEventListener('DOMContentLoaded', function () {
        attachSelectCustomerEvents();
        attachSelectProductEvents();
        const emailInput = document.querySelector('input[name="email"]');

        // Add event listener for quantity input validation
        const quantityInput = document.getElementById('selectedProductQuantity');
        if (quantityInput) {
            quantityInput.addEventListener('input', validateQuantityInput);
        }

        // Add event listener for customer search form
        const customerSearchForm = document.getElementById('customerSearchForm');
        if (customerSearchForm) {
            customerSearchForm.addEventListener('submit', function (e) {
                e.preventDefault();
                searchCustomers();
            });
        }

        if (emailInput) {
            emailInput.addEventListener('input', validateEmailFormat);
            emailInput.addEventListener('blur', validateEmail);
        }

        // Add event listener for product search form
        const productSearchForm = document.getElementById('productSearchForm');
        if (productSearchForm) {
            productSearchForm.addEventListener('submit', function (e) {
                e.preventDefault();
                searchProducts();
            });
        }
    });

    function selectCustomer(customerId) {
        // Gọi API lấy thông tin chi tiết khách hàng
        fetch(`/Sale/customers/${customerId}`)
            .then(response => response.json())
            .then(customer => {
                // Điền thông tin vào form
                document.querySelector('input[name="customerName"]').value = customer.customerName || '';
                document.querySelector('input[name="phoneNumber"]').value = customer.phoneNumber || '';
                document.querySelector('input[name="address"]').value = customer.address || '';
                document.querySelector('input[name="birthdayDate"]').value = customer.birthdayDate || '';
                document.querySelector('input[name="email"]').value = customer.email || '';

                // Disable tất cả các input field
                document.querySelectorAll('.customer-input').forEach(input => {
                    input.setAttribute('readonly', true);
                });

                // Nếu có email thì coi như đã xác thực
                if (customer.email) {
                    emailVerified = true;
                    lastVerifiedEmail = customer.email;
                    updateVerifyButton();
                }

                // Hiển thị nút reset
                document.getElementById('resetCustomerBtn').style.display = 'block';

                // Đóng modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('customerModal'));
                modal.hide();
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Có lỗi xảy ra khi lấy thông tin khách hàng!');
            });
    }

    // Thêm event listener cho nút reset
    document.getElementById('resetCustomerBtn').addEventListener('click', function () {
        // Xóa giá trị của tất cả các input
        document.querySelectorAll('.customer-input').forEach(input => {
            input.value = '';
            input.removeAttribute('readonly');
        });

        // Reset trạng thái xác thực email
        emailVerified = false;
        lastVerifiedEmail = '';
        updateVerifyButton();

        // Ẩn nút reset
        this.style.display = 'none';
    });

    // Cập nhật xử lý form submit
    document.getElementById('saleForm').addEventListener('submit', function (e) {
        // Kiểm tra email đã xác thực chưa
        if (!emailVerified) {
            alert('Vui lòng xác nhận email trước khi thanh toán!');
            e.preventDefault();
            return;
        }
        e.preventDefault();
        // Kiểm tra thông tin khách hàng
        const customerName = document.querySelector('input[name="customerName"]').value;
        const phoneNumber = document.querySelector('input[name="phoneNumber"]').value;
        if (!customerName || !phoneNumber) {
            alert('Vui lòng nhập đầy đủ thông tin khách hàng!');
            return;
        }

        // Kiểm tra sản phẩm đã chọn trong bảng
        if (!selectedProducts.length) {
            alert('Vui lòng chọn sản phẩm và số lượng!');
            return;
        }

        // Kiểm tra phương thức thanh toán
        const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked');
        if (!paymentMethod) {
            alert('Vui lòng chọn phương thức thanh toán!');
            return;
        }

        // Xóa các input ẩn cũ
        document.querySelectorAll('.product-hidden-input').forEach(el => el.remove());

        // Thêm thông tin sản phẩm vào form
        selectedProducts.forEach((product, index) => {
            // Thêm tên sản phẩm
            const productNameInput = document.createElement('input');
            productNameInput.type = 'hidden';
            productNameInput.className = 'product-hidden-input';
            productNameInput.name = `products[${index}].productName`;
            productNameInput.value = product.productName;
            this.appendChild(productNameInput);

            // Thêm giá sản phẩm
            const priceInput = document.createElement('input');
            priceInput.type = 'hidden';
            priceInput.className = 'product-hidden-input';
            priceInput.name = `products[${index}].price`;
            priceInput.value = product.price;
            this.appendChild(priceInput);

            // Thêm số lượng
            const quantityInput = document.createElement('input');
            quantityInput.type = 'hidden';
            quantityInput.className = 'product-hidden-input';
            quantityInput.name = `products[${index}].quantity`;
            quantityInput.value = product.quantity;
            this.appendChild(quantityInput);
        });

        // Submit form
        this.submit();
    });

    // Thêm hàm xử lý thanh toán VNPay
    function handleVNPayPayment(orderId, amount) {
        fetch('/api/vnpay/create-payment', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                orderId: orderId,
                amount: amount
            })
        })
            .then(response => response.json())
            .then(data => {
                if (data.paymentUrl) {
                    window.location.href = data.paymentUrl;
                } else {
                    alert('Có lỗi xảy ra khi tạo URL thanh toán!');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Có lỗi xảy ra khi xử lý thanh toán!');
            });
    }

    function showProductModal() {
        const modal = new bootstrap.Modal(document.getElementById('productModal'));
        modal.show();
    }

    let emailValidationTimeout;
    let emailVerified = false;
    let lastVerifiedEmail = '';

    function updateVerifyButton() {
        const emailInput = document.querySelector('input[name="email"]');
        const verifyBtn = document.getElementById('verifyEmailBtn');
        const verifiedBtn = document.getElementById('verifiedEmailBtn');
        const submitBtn = document.getElementById('submitSaleBtn');
        const email = emailInput.value.trim();
        if (verifyBtn) {
            verifyBtn.classList.remove('btn-outline-secondary');
            verifyBtn.classList.add('btn-primary');
        }
        if (emailVerified && email === lastVerifiedEmail) {
            verifyBtn.style.display = 'none';
            verifiedBtn.style.display = 'inline-block';
            if (submitBtn) submitBtn.disabled = false;
        } else if (isValidEmail(email)) {
            verifyBtn.style.display = 'inline-block';
            verifiedBtn.style.display = 'none';
            if (submitBtn) submitBtn.disabled = true;
        } else {
            verifyBtn.style.display = 'none';
            verifiedBtn.style.display = 'none';
            if (submitBtn) submitBtn.disabled = true;
        }
    }

    // Khi email thay đổi, reset trạng thái xác thực
    const emailInput = document.querySelector('input[name="email"]');
    if (emailInput) {
        emailInput.addEventListener('input', function() {
            emailVerified = false;
            lastVerifiedEmail = '';
            updateVerifyButton();
        });
        emailInput.addEventListener('blur', updateVerifyButton);
    }

    // Xử lý nút Verify
    const verifyBtn = document.getElementById('verifyEmailBtn');
    if (verifyBtn) {
        verifyBtn.addEventListener('click', function() {
            const email = emailInput.value.trim();
            if (!isValidEmail(email)) {
                showValidationError(emailInput, 'Email phải có định dạng hợp lệ (ví dụ: example@domain.com)');
                return;
            }
            verifyBtn.disabled = true;
            fetch('/Sale/send-otp?email=' + encodeURIComponent(email), { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    verifyBtn.disabled = false;
                    if (data.success) {
                        // Mở modal nhập OTP
                        const otpModal = new bootstrap.Modal(document.getElementById('otpModal'));
                        document.getElementById('otpInput').value = '';
                        document.getElementById('otpError').style.display = 'none';
                        otpModal.show();
                    } else {
                        alert(data.message || 'Không thể gửi OTP!');
                    }
                })
                .catch(() => {
                    verifyBtn.disabled = false;
                    alert('Có lỗi khi gửi OTP!');
                });
        });
    }

    // Xử lý xác nhận OTP
    const submitOtpBtn = document.getElementById('submitOtpBtn');
    if (submitOtpBtn) {
        submitOtpBtn.addEventListener('click', function() {
            const otp = document.getElementById('otpInput').value.trim();
            const email = emailInput.value.trim();
            const otpError = document.getElementById('otpError');
            if (!otp) {
                otpError.textContent = 'Vui lòng nhập mã OTP.';
                otpError.style.display = 'block';
                return;
            }
            submitOtpBtn.disabled = true;
            fetch('/Sale/verify-otp', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email: email, otp: otp })
            })
            .then(response => response.json())
            .then(data => {
                submitOtpBtn.disabled = false;
                if (data.verified) {
                    emailVerified = true;
                    lastVerifiedEmail = email;
                    updateVerifyButton();
                    const otpModal = bootstrap.Modal.getInstance(document.getElementById('otpModal'));
                    otpModal.hide();
                } else {
                    otpError.textContent = data.message || 'Mã OTP không đúng hoặc đã hết hạn!';
                    otpError.style.display = 'block';
                }
            })
            .catch(() => {
                submitOtpBtn.disabled = false;
                otpError.textContent = 'Có lỗi khi xác thực OTP!';
                otpError.style.display = 'block';
            });
        });
    }

    // Khi mở modal OTP, focus vào input
    const otpModalEl = document.getElementById('otpModal');
    if (otpModalEl) {
        otpModalEl.addEventListener('shown.bs.modal', function () {
            document.getElementById('otpInput').focus();
        });
    }

    // Gọi lại updateVerifyButton khi DOM loaded
    if (emailInput) {
        document.addEventListener('DOMContentLoaded', updateVerifyButton);
    }

    // Validate email format
    function validateEmailFormat() {
        const emailInput = document.querySelector('input[name="email"]');
        const emailValue = emailInput.value.trim();

        // Remove existing validation message
        removeValidationMessage(emailInput);

        if (emailValue.length > 0) {
            // Check if email has valid format
            if (!isValidEmail(emailValue)) {
                showValidationError(emailInput, 'Email phải có định dạng hợp lệ (ví dụ: example@domain.com)');
                return false;
            }
        }

        return true;
    }

    // Validate email (format + duplicate check)
    function validateEmail() {
        const emailInput = document.querySelector('input[name="email"]');
        const emailValue = emailInput.value.trim();

        // First validate format
        if (!validateEmailFormat()) {
            return;
        }

        // Then check for duplicates if format is valid
        if (emailValue.length > 0 && isValidEmail(emailValue)) {
            clearTimeout(emailValidationTimeout);
            emailValidationTimeout = setTimeout(() => {
                fetch('/Sale/check-email?email=' + encodeURIComponent(emailValue))
                    .then(response => response.json())
                    .then(data => {
                        if (data.exists) {
                            showValidationError(emailInput, 'Email này đã được sử dụng bởi khách hàng khác!');
                        }
                    })
                    .catch(error => {
                        console.error('Error checking email:', error);
                    });
            }, 500);
        }
    }

    // Helper function to validate email format
    function isValidEmail(email) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(email);
    }

    // Show validation error
    function showValidationError(inputElement, message) {
        inputElement.classList.add('is-invalid');

        let feedback = inputElement.parentNode.querySelector('.client-validation-feedback');
        if (!feedback) {
            feedback = document.createElement('div');
            feedback.classList.add('client-validation-feedback', 'invalid-feedback');
            inputElement.parentNode.appendChild(feedback);
        }
        feedback.textContent = message;
    }

    // Remove validation message
    function removeValidationMessage(inputElement) {
        inputElement.classList.remove('is-invalid');
        const feedback = inputElement.parentNode.querySelector('.client-validation-feedback');
        if (feedback) {
            feedback.remove();
        }
    }

    // Add JS to show/hide loading overlay on Verify and form submit
    (function() {
        function showLoading() {
            document.getElementById('loading-overlay').style.display = 'flex';
        }
        function hideLoading() {
            document.getElementById('loading-overlay').style.display = 'none';
        }
        // Show loading on form submit
        var saleForm = document.getElementById('saleForm');
        if (saleForm) {
            saleForm.addEventListener('submit', function(e) {
                // Only show loading if validation passes and about to submit
                if (emailVerified && document.querySelector('input[name="customerName"]').value && document.querySelector('input[name="phoneNumber"]').value && selectedProducts.length && document.querySelector('input[name="paymentMethod"]:checked')) {
                    showLoading();
                }
            });
        }
        // Show loading on Verify click
        var verifyBtn = document.getElementById('verifyEmailBtn');
        if (verifyBtn) {
            verifyBtn.addEventListener('click', function() {
                if (isValidEmail(document.querySelector('input[name="email"]').value.trim())) {
                    showLoading();
                }
            });
        }
        // Hide loading on AJAX completion/errors for Verify/OTP
        // Patch fetch for /Sale/send-otp and /Sale/verify-otp
        const origFetch = window.fetch;
        window.fetch = function() {
            const url = arguments[0];
            if (typeof url === 'string' && (url.includes('/Sale/send-otp') || url.includes('/Sale/verify-otp'))) {
                return origFetch.apply(this, arguments).finally(hideLoading);
            }
            return origFetch.apply(this, arguments);
        };
        // Hide loading on page load (in case left open)
        document.addEventListener('DOMContentLoaded', hideLoading);
    })();

    // --- PHONE VALIDATION ---
    let phoneValidationTimeout;
    function isValidPhone(phone) {
        // 10 hoặc 11 số, không ký tự đặc biệt
        return /^\d{10,11}$/.test(phone);
    }
    function showPhoneValidationError(message) {
        const phoneInput = document.querySelector('input[name="phoneNumber"]');
        let feedback = phoneInput.parentNode.querySelector('.client-validation-feedback');
        if (feedback) {
            feedback.textContent = message;
            feedback.style.display = 'block';
        }
        phoneInput.classList.add('is-invalid');
    }
    function removePhoneValidationError() {
        const phoneInput = document.querySelector('input[name="phoneNumber"]');
        let feedback = phoneInput.parentNode.querySelector('.client-validation-feedback');
        if (feedback) {
            feedback.textContent = '';
            feedback.style.display = 'none';
        }
        phoneInput.classList.remove('is-invalid');
    }
    function validatePhoneFormat() {
        const phoneInput = document.querySelector('input[name="phoneNumber"]');
        const phoneValue = phoneInput.value.trim();
        removePhoneValidationError();
        if (phoneValue.length > 0 && !isValidPhone(phoneValue)) {
            showPhoneValidationError('Số điện thoại phải có 10 hoặc 11 chữ số!');
            return false;
        }
        return true;
    }
    function validatePhone() {
        const phoneInput = document.querySelector('input[name="phoneNumber"]');
        const phoneValue = phoneInput.value.trim();
        if (!validatePhoneFormat()) return;
        if (phoneValue.length > 0 && isValidPhone(phoneValue)) {
            clearTimeout(phoneValidationTimeout);
            phoneValidationTimeout = setTimeout(() => {
                fetch('/Sale/check-phone?phone=' + encodeURIComponent(phoneValue))
                    .then(response => response.json())
                    .then(data => {
                        if (data.exists) {
                            showPhoneValidationError('Số điện thoại này đã được sử dụng bởi khách hàng khác!');
                        }
                    })
                    .catch(error => {
                        // Không báo lỗi network ra giao diện
                    });
            }, 500);
        }
    }
    // Gắn event cho input phone
    document.addEventListener('DOMContentLoaded', function () {
        const phoneInput = document.querySelector('input[name="phoneNumber"]');
        if (phoneInput) {
            phoneInput.addEventListener('input', function() {
                removePhoneValidationError();
            });
            phoneInput.addEventListener('input', validatePhoneFormat);
            phoneInput.addEventListener('blur', validatePhone);
        }
    });
</script>
</body>
</html>