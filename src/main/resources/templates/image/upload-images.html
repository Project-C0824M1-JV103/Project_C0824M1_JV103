<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Upload Ảnh với Cloudinary</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
    />
    <style>
      .upload-container {
        max-width: 900px;
        margin: 50px auto;
        padding: 30px;
        background: #fff;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      }

      .upload-area {
        border: 2px dashed #dee2e6;
        border-radius: 10px;
        padding: 40px;
        text-align: center;
        transition: all 0.3s ease;
        cursor: pointer;
        min-height: 200px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
      }

      .upload-area:hover {
        border-color: #0d6efd;
        background-color: #f8f9fa;
      }

      .upload-area.dragover {
        border-color: #0d6efd;
        background-color: #e3f2fd;
      }

      .preview-container {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        margin-top: 20px;
      }

      .image-preview {
        position: relative;
        width: 200px;
        height: 200px;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }

      .image-preview img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .delete-btn {
        position: absolute;
        top: 8px;
        right: 8px;
        background: rgba(220, 53, 69, 0.8);
        border: none;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        color: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .delete-btn:hover {
        background: rgba(220, 53, 69, 1);
      }

      .upload-progress {
        display: none;
        margin-top: 20px;
      }

      .upload-type-tabs {
        margin-bottom: 30px;
      }

      .tab-content {
        margin-top: 20px;
      }
    </style>
  </head>
  <body class="bg-light">
    <div class="container">
      <div class="upload-container">
        <div class="text-center mb-4">
          <h2 class="text-primary">
            <i class="bi bi-cloud-upload"></i>
            Upload Ảnh với Cloudinary
          </h2>
          <p class="text-muted">
            Hỗ trợ nhiều ảnh - JPG, PNG, GIF. Tối đa 10MB mỗi file
          </p>
        </div>

        <!-- Upload Type Tabs -->
        <div class="upload-type-tabs">
          <ul class="nav nav-pills nav-fill" id="uploadTabs" role="tablist">
            <li class="nav-item" role="presentation">
              <button
                class="nav-link active"
                id="product-tab"
                data-bs-toggle="pill"
                data-bs-target="#product-upload"
                type="button"
                role="tab"
              >
                <i class="bi bi-box"></i> Ảnh Sản Phẩm
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button
                class="nav-link"
                id="avatar-tab"
                data-bs-toggle="pill"
                data-bs-target="#avatar-upload"
                type="button"
                role="tab"
              >
                <i class="bi bi-person-circle"></i> Avatar Nhân Viên
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button
                class="nav-link"
                id="multiple-tab"
                data-bs-toggle="pill"
                data-bs-target="#multiple-upload"
                type="button"
                role="tab"
              >
                <i class="bi bi-images"></i> Upload Nhiều Ảnh
              </button>
            </li>
          </ul>
        </div>

        <!-- Tab Content -->
        <div class="tab-content" id="uploadTabContent">
          <!-- Product Upload -->
          <div
            class="tab-pane fade show active"
            id="product-upload"
            role="tabpanel"
          >
            <div
              class="upload-area"
              onclick="document.getElementById('productFile').click()"
            >
              <i
                class="bi bi-cloud-upload-fill text-primary"
                style="font-size: 3rem"
              ></i>
              <h5 class="mt-3">Upload Ảnh Sản Phẩm</h5>
              <p class="text-muted">Click để chọn hoặc kéo thả ảnh vào đây</p>
            </div>
            <input
              type="file"
              id="productFile"
              multiple
              accept="image/*"
              style="display: none"
            />

            <div class="text-center mt-3">
              <button class="btn btn-primary" id="uploadProductBtn" disabled>
                <i class="bi bi-upload"></i> Upload Ảnh Sản Phẩm
              </button>
              <button
                class="btn btn-outline-secondary ms-2"
                onclick="clearFiles('product')"
              >
                <i class="bi bi-x-circle"></i> Xóa
              </button>
            </div>

            <div class="preview-container" id="productPreview"></div>
          </div>

          <!-- Avatar Upload -->
          <div class="tab-pane fade" id="avatar-upload" role="tabpanel">
            <div
              class="upload-area"
              onclick="document.getElementById('avatarFile').click()"
            >
              <i
                class="bi bi-person-plus-fill text-primary"
                style="font-size: 3rem"
              ></i>
              <h5 class="mt-3">Upload Avatar Nhân Viên</h5>
              <p class="text-muted">Ảnh sẽ được resize thành 300x300px</p>
            </div>
            <input
              type="file"
              id="avatarFile"
              accept="image/*"
              style="display: none"
            />

            <div class="text-center mt-3">
              <button class="btn btn-success" id="uploadAvatarBtn" disabled>
                <i class="bi bi-upload"></i> Upload Avatar
              </button>
              <button
                class="btn btn-outline-secondary ms-2"
                onclick="clearFiles('avatar')"
              >
                <i class="bi bi-x-circle"></i> Xóa
              </button>
            </div>

            <div class="preview-container" id="avatarPreview"></div>
          </div>

          <!-- Multiple Upload -->
          <div class="tab-pane fade" id="multiple-upload" role="tabpanel">
            <div
              class="upload-area"
              onclick="document.getElementById('multipleFiles').click()"
            >
              <i class="bi bi-images text-primary" style="font-size: 3rem"></i>
              <h5 class="mt-3">Upload Nhiều Ảnh</h5>
              <p class="text-muted">Chọn nhiều file cùng lúc</p>
            </div>
            <input
              type="file"
              id="multipleFiles"
              multiple
              accept="image/*"
              style="display: none"
            />

            <div class="text-center mt-3">
              <button class="btn btn-info" id="uploadMultipleBtn" disabled>
                <i class="bi bi-upload"></i> Upload Tất Cả
              </button>
              <button
                class="btn btn-outline-secondary ms-2"
                onclick="clearFiles('multiple')"
              >
                <i class="bi bi-x-circle"></i> Xóa
              </button>
            </div>

            <div class="preview-container" id="multiplePreview"></div>
          </div>
        </div>

        <!-- Progress Bar -->
        <div class="upload-progress">
          <div class="progress">
            <div
              class="progress-bar progress-bar-striped progress-bar-animated"
              id="progressBar"
              role="progressbar"
              style="width: 0%"
            ></div>
          </div>
          <p class="text-center mt-2" id="progressText">Đang upload...</p>
        </div>

        <!-- Results -->
        <div class="mt-4">
          <div
            class="alert alert-success"
            id="successAlert"
            style="display: none"
          >
            <i class="bi bi-check-circle-fill"></i>
            <span id="successMessage"></span>
          </div>
          <div class="alert alert-danger" id="errorAlert" style="display: none">
            <i class="bi bi-exclamation-triangle-fill"></i>
            <span id="errorMessage"></span>
          </div>
        </div>

        <!-- URLs Display -->
        <div id="urlsContainer" style="display: none">
          <h5>URLs đã upload:</h5>
          <textarea
            class="form-control"
            id="urlsTextarea"
            rows="5"
            readonly
          ></textarea>
          <button class="btn btn-outline-info mt-2" onclick="copyUrls()">
            <i class="bi bi-clipboard"></i> Copy URLs
          </button>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      let uploadedUrls = [];

      // Initialize event listeners
      document.addEventListener("DOMContentLoaded", function () {
        setupFileInputs();
        setupDragAndDrop();
        setupUploadButtons();
      });

      function setupFileInputs() {
        document
          .getElementById("productFile")
          .addEventListener("change", (e) => handleFileSelect(e, "product"));
        document
          .getElementById("avatarFile")
          .addEventListener("change", (e) => handleFileSelect(e, "avatar"));
        document
          .getElementById("multipleFiles")
          .addEventListener("change", (e) => handleFileSelect(e, "multiple"));
      }

      function setupDragAndDrop() {
        const uploadAreas = document.querySelectorAll(".upload-area");
        uploadAreas.forEach((area) => {
          area.addEventListener("dragover", handleDragOver);
          area.addEventListener("dragleave", handleDragLeave);
          area.addEventListener("drop", handleDrop);
        });
      }

      function setupUploadButtons() {
        document
          .getElementById("uploadProductBtn")
          .addEventListener("click", () => uploadFiles("product"));
        document
          .getElementById("uploadAvatarBtn")
          .addEventListener("click", () => uploadFiles("avatar"));
        document
          .getElementById("uploadMultipleBtn")
          .addEventListener("click", () => uploadFiles("multiple"));
      }

      function handleFileSelect(event, type) {
        const files = Array.from(event.target.files);
        previewFiles(files, type);
        updateUploadButton(type, files.length > 0);
      }

      function handleDragOver(e) {
        e.preventDefault();
        e.currentTarget.classList.add("dragover");
      }

      function handleDragLeave(e) {
        e.preventDefault();
        e.currentTarget.classList.remove("dragover");
      }

      function handleDrop(e) {
        e.preventDefault();
        e.currentTarget.classList.remove("dragover");

        const files = Array.from(e.dataTransfer.files);
        const type = e.currentTarget.closest(".tab-pane").id.split("-")[0];

        previewFiles(files, type);
        updateUploadButton(type, files.length > 0);
      }

      function previewFiles(files, type) {
        const previewContainer = document.getElementById(type + "Preview");
        previewContainer.innerHTML = "";

        files.forEach((file, index) => {
          if (file.type.startsWith("image/")) {
            const reader = new FileReader();
            reader.onload = function (e) {
              const previewDiv = document.createElement("div");
              previewDiv.className = "image-preview";
              previewDiv.innerHTML = `
                            <img src="${e.target.result}" alt="${file.name}">
                            <button class="delete-btn" onclick="removePreview(this, '${type}')">
                                <i class="bi bi-x"></i>
                            </button>
                        `;
              previewContainer.appendChild(previewDiv);
            };
            reader.readAsDataURL(file);
          }
        });
      }

      function removePreview(button, type) {
        button.parentElement.remove();

        // Check if any previews left
        const previewContainer = document.getElementById(type + "Preview");
        const hasFiles = previewContainer.children.length > 0;
        updateUploadButton(type, hasFiles);
      }

      function updateUploadButton(type, hasFiles) {
        const button = document.getElementById(
          "upload" + type.charAt(0).toUpperCase() + type.slice(1) + "Btn"
        );
        button.disabled = !hasFiles;
      }

      async function uploadFiles(type) {
        let fileInput, endpoint;

        switch (type) {
          case "product":
            fileInput = document.getElementById("productFile");
            endpoint = "/api/images/upload/product";
            break;
          case "avatar":
            fileInput = document.getElementById("avatarFile");
            endpoint = "/api/images/upload/avatar";
            break;
          case "multiple":
            fileInput = document.getElementById("multipleFiles");
            endpoint = "/api/images/upload/multiple";
            break;
        }

        const files = fileInput.files;
        if (files.length === 0) return;

        showProgress(true);
        hideAlerts();

        try {
          if (type === "multiple") {
            await uploadMultipleFiles(files, endpoint);
          } else {
            await uploadSingleFile(files[0], endpoint);
          }
        } catch (error) {
          showError("Lỗi upload: " + error.message);
        } finally {
          showProgress(false);
        }
      }

      async function uploadSingleFile(file, endpoint) {
        const formData = new FormData();
        formData.append("file", file);

        const response = await fetch(endpoint, {
          method: "POST",
          body: formData,
        });

        const result = await response.json();

        if (result.success) {
          uploadedUrls.push(result.imageUrl);
          showSuccess(result.message);
          updateUrlsDisplay();
        } else {
          showError(result.message);
        }
      }

      async function uploadMultipleFiles(files, endpoint) {
        const formData = new FormData();
        Array.from(files).forEach((file) => {
          formData.append("files", file);
        });

        const response = await fetch(endpoint, {
          method: "POST",
          body: formData,
        });

        const result = await response.json();

        if (result.success) {
          Object.values(result.images).forEach((url) => uploadedUrls.push(url));
          showSuccess(result.message);
          updateUrlsDisplay();
        } else {
          showError(result.message);
        }
      }

      function clearFiles(type) {
        const fileInput = document.getElementById(
          type === "multiple" ? "multipleFiles" : type + "File"
        );
        const previewContainer = document.getElementById(type + "Preview");

        fileInput.value = "";
        previewContainer.innerHTML = "";
        updateUploadButton(type, false);
        hideAlerts();
      }

      function showProgress(show) {
        const progressDiv = document.querySelector(".upload-progress");
        progressDiv.style.display = show ? "block" : "none";

        if (show) {
          document.getElementById("progressBar").style.width = "100%";
        }
      }

      function showSuccess(message) {
        const alert = document.getElementById("successAlert");
        document.getElementById("successMessage").textContent = message;
        alert.style.display = "block";
        hideError();
      }

      function showError(message) {
        const alert = document.getElementById("errorAlert");
        document.getElementById("errorMessage").textContent = message;
        alert.style.display = "block";
        hideSuccess();
      }

      function hideAlerts() {
        hideSuccess();
        hideError();
      }

      function hideSuccess() {
        document.getElementById("successAlert").style.display = "none";
      }

      function hideError() {
        document.getElementById("errorAlert").style.display = "none";
      }

      function updateUrlsDisplay() {
        if (uploadedUrls.length > 0) {
          const container = document.getElementById("urlsContainer");
          const textarea = document.getElementById("urlsTextarea");

          textarea.value = uploadedUrls.join("\n");
          container.style.display = "block";
        }
      }

      function copyUrls() {
        const textarea = document.getElementById("urlsTextarea");
        textarea.select();
        document.execCommand("copy");
        showSuccess("Đã copy URLs vào clipboard!");
      }

      // Delete image function
      async function deleteImage(imageUrl) {
        if (!confirm("Bạn có chắc muốn xóa ảnh này?")) return;

        try {
          const response = await fetch(
            `/api/images/delete?imageUrl=${encodeURIComponent(imageUrl)}`,
            {
              method: "DELETE",
            }
          );

          const result = await response.json();

          if (result.success) {
            uploadedUrls = uploadedUrls.filter((url) => url !== imageUrl);
            updateUrlsDisplay();
            showSuccess("Đã xóa ảnh thành công!");
          } else {
            showError("Không thể xóa ảnh: " + result.message);
          }
        } catch (error) {
          showError("Lỗi xóa ảnh: " + error.message);
        }
      }
    </script>
  </body>
</html>
