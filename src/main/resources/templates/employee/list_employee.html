<!DOCTYPE html>
<html
  lang="en"
  xmlns:th="http://www.thymeleaf.org"
  xmlns="http://www.w3.org/1999/html"
>
  <head>
    <meta charset="UTF-8" />
    <title>Employee Management</title>

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Bootstrap Icons -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css"
    />

    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
        background-color: #f8f9fa;
      }

      table {
        border-collapse: collapse;
        width: 100%;
        margin-top: 20px;
      }

      th,
      td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: left;
      }

      th {
        background-color: #f2f2f2;
      }

      .btn {
        padding: 8px 16px;
        margin: 5px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
      }

      .btn-danger {
        background-color: #dc3545;
        color: white;
      }

      .btn-danger:hover {
        background-color: #c82333;
      }

      .btn-danger:disabled {
        background-color: #6c757d;
        cursor: not-allowed;
      }

      /* Modal styles */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 1055;
        outline: 0;
      }

      .modal.show {
        display: block !important;
      }

      .modal-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        z-index: 1050;
        width: 100vw;
        height: 100vh;
        background-color: #000;
        opacity: 0.5;
      }

      body.modal-open {
        overflow: hidden;
        padding-right: 0;
      }

      .modal-dialog {
        position: relative;
        width: auto;
        margin: 1.75rem;
        pointer-events: none;
      }

      .modal.show .modal-dialog {
        transform: none;
      }

      .modal-content {
        position: relative;
        display: flex;
        flex-direction: column;
        width: 100%;
        pointer-events: auto;
        background-color: #fff;
        background-clip: padding-box;
        border: 1px solid rgba(0, 0, 0, 0.125);
        border-radius: 0.375rem;
        outline: 0;
      }

      /* Animation */
      .fade {
        transition: opacity 0.15s linear;
      }

      .fade:not(.show) {
        opacity: 0;
      }

      .modal.fade .modal-dialog {
        transition: transform 0.3s ease-out;
        transform: translate(0, -50px);
      }

      .modal.show .modal-dialog {
        transform: none;
      }

      /* Responsive */
      @media (min-width: 576px) {
        .modal-dialog {
          max-width: 500px;
          margin: 1.75rem auto;
        }
      }

      @media (min-width: 992px) {
        .modal-lg {
          max-width: 800px;
        }
      }

      /* Button hover effects */
      .btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .delete-single-btn:hover {
        transform: scale(1.05);
      }

      .employee-info {
        background-color: #f8f9fa;
        padding: 10px;
        margin: 10px 0;
        border-left: 4px solid #dc3545;
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        background: linear-gradient(135deg, #e53e3e 0%, #c53030 100%);
        color: white;
        border-bottom: none;
      }

      .modal-title {
        color: #dc3545;
        margin: 0;
      }

      .close {
        color: #aaa;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
      }

      .close:hover {
        color: black;
      }

      .employee-info-card {
        background: linear-gradient(135deg, #fff5f5 0%, #fed7d7 100%);
        border: 1px solid #fc8181;
        border-radius: 8px;
        padding: 15px;
        margin: 10px 0;
        border-left: 4px solid #e53e3e;
      }

      .modal-header .btn-close {
        filter: invert(1);
      }

      .selected-count {
        font-weight: 500;
        color: #718096;
      }

      .checkbox-column {
        width: 50px;
        text-align: center;
      }

      .action-column {
        width: 100px;
        text-align: center;
      }

      .container {
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        padding: 30px;
        margin-top: 30px;
      }

      .table th {
        background-color: #e9ecef;
        border-top: none;
      }

      .btn-outline-danger:hover {
        transform: translateY(-1px);
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="row">
        <div class="col-12">
          <h2 class="mb-4">
            <i class="bi bi-people-fill text-primary"></i>
            Quản lý nhân viên
          </h2>

          <!-- Success/Error Messages -->
          <div
            th:if="${successMessage}"
            class="alert alert-success alert-dismissible fade show"
            role="alert"
          >
            <i class="bi bi-check-circle-fill"></i>
            <span th:text="${successMessage}"></span>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="alert"
            ></button>
          </div>

          <div
            th:if="${errorMessage}"
            class="alert alert-danger alert-dismissible fade show"
            role="alert"
          >
            <i class="bi bi-exclamation-triangle-fill"></i>
            <span th:text="${errorMessage}"></span>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="alert"
            ></button>
          </div>

          <!-- Action Buttons -->
          <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
              <button
                id="deleteSelectedBtn"
                class="btn btn-outline-danger"
                disabled
                data-bs-toggle="modal"
                data-bs-target="#deleteModal"
              >
                <i class="bi bi-trash3"></i>
                Xóa nhân viên đã chọn
              </button>
              <span id="selectedCount" class="selected-count ms-2"></span>
            </div>

            <div>
              <button class="btn btn-primary">
                <i class="bi bi-plus-circle"></i>
                Thêm nhân viên
              </button>
            </div>
          </div>

          <!-- Employee Table -->
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th class="checkbox-column">
                    <div class="form-check">
                      <input
                        class="form-check-input"
                        type="checkbox"
                        id="selectAll"
                        onchange="toggleSelectAll()"
                      />
                      <label class="form-check-label" for="selectAll"></label>
                    </div>
                  </th>
                  <th>ID</th>
                  <th>Tên đầy đủ</th>
                  <th>Email</th>
                  <th>Số điện thoại</th>
                  <th>Chức vụ</th>
                  <th>Trạng thái</th>
                  <th class="action-column">Thao tác</th>
                </tr>
              </thead>
              <tbody>
                <tr th:each="e, iterStat : ${listEmployee}">
                  <td class="checkbox-column">
                    <div class="form-check">
                      <input
                        class="form-check-input employee-checkbox"
                        type="checkbox"
                        th:value="${e.employeeId}"
                        th:data-name="${e.fullName}"
                        th:data-email="${e.email}"
                        th:data-phone="${e.phone}"
                        th:id="'check-' + ${e.employeeId}"
                        onchange="updateDeleteButton()"
                      />
                      <label
                        class="form-check-label"
                        th:for="'check-' + ${e.employeeId}"
                      ></label>
                    </div>
                  </td>
                  <td th:text="${e.employeeId}"></td>
                  <td th:text="${e.fullName}"></td>
                  <td th:text="${e.email}"></td>
                  <td th:text="${e.phone}"></td>
                  <td>
                    <span class="badge bg-info" th:text="${e.role}"></span>
                  </td>
                  <td>
                    <span
                      th:class="${e.status.name() == 'active'} ? 'badge bg-success' : 'badge bg-secondary'"
                      th:text="${e.status}"
                    ></span>
                  </td>
                  <td class="action-column">
                    <button
                      class="btn btn-outline-danger btn-sm delete-single-btn"
                      th:attr="data-employee-id=${e.employeeId},data-employee-name=${e.fullName},data-employee-email=${e.email},data-employee-phone=${e.phone}"
                    >
                      <i class="bi bi-trash3"></i>
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Bootstrap Delete Modal -->
    <div
      class="modal fade"
      id="deleteModal"
      tabindex="-1"
      aria-labelledby="deleteModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="deleteModalLabel">
              <i class="bi bi-exclamation-triangle-fill"></i>
              Xác nhận xóa nhân viên
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>

          <div class="modal-body">
            <div class="row">
              <div class="col-12">
                <h6 class="text-danger mb-3">
                  <i class="bi bi-exclamation-circle"></i>
                  Bạn có chắc chắn muốn xóa những nhân viên sau không?
                </h6>

                <div id="employeeList" class="mb-3">
                  <!-- Employee info will be populated here -->
                </div>

                <div class="alert alert-warning" role="alert">
                  <i class="bi bi-info-circle-fill"></i>
                  <strong>Lưu ý:</strong> Hành động này không thể hoàn tác sau
                  khi thực hiện!
                </div>
              </div>
            </div>
          </div>

          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              <i class="bi bi-x-circle"></i>
              Hủy bỏ
            </button>
            <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
              <i class="bi bi-trash3-fill"></i>
              Xác nhận xóa
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      let selectedEmployees = [];

      // Initialize event listeners
      document.addEventListener("DOMContentLoaded", function () {
        console.log("DOM loaded");

        // Add event listener for single delete buttons using event delegation
        document.body.addEventListener("click", function (e) {
          // Handle single delete button
          if (e.target.closest(".delete-single-btn")) {
            console.log("Delete single button clicked");
            const btn = e.target.closest(".delete-single-btn");
            const employeeId = btn.getAttribute("data-employee-id");
            const employeeName = btn.getAttribute("data-employee-name");
            const employeeEmail = btn.getAttribute("data-employee-email");
            const employeePhone = btn.getAttribute("data-employee-phone");

            showDeleteSingleModal(
              employeeId,
              employeeName,
              employeeEmail,
              employeePhone
            );
            return;
          }

          // Handle delete selected button
          if (e.target.id === "deleteSelectedBtn" && !e.target.disabled) {
            console.log("Delete selected button clicked");
            showDeleteModal();
            return;
          }

          // Handle modal close button
          if (
            e.target.closest(".btn-close") ||
            e.target.closest('[data-bs-dismiss="modal"]')
          ) {
            closeModal();
            return;
          }

          // Handle confirm delete button
          if (e.target.closest('button[id="confirmDeleteBtn"]')) {
            confirmDelete();
            return;
          }
        });

        // Close modal when clicking backdrop
        document
          .getElementById("deleteModal")
          .addEventListener("click", function (e) {
            if (e.target === this) {
              closeModal();
            }
          });
      });

      // Simple modal control functions
      function showModal() {
        const modal = document.getElementById("deleteModal");
        modal.style.display = "block";
        modal.classList.add("show");
        document.body.classList.add("modal-open");

        // Add backdrop
        if (!document.querySelector(".modal-backdrop")) {
          const backdrop = document.createElement("div");
          backdrop.className = "modal-backdrop fade show";
          document.body.appendChild(backdrop);
        }
      }

      function closeModal() {
        const modal = document.getElementById("deleteModal");
        modal.style.display = "none";
        modal.classList.remove("show");
        document.body.classList.remove("modal-open");

        // Remove backdrop
        const backdrop = document.querySelector(".modal-backdrop");
        if (backdrop) {
          backdrop.remove();
        }
      }

      // Toggle select all checkboxes
      function toggleSelectAll() {
        const selectAll = document.getElementById("selectAll");
        const checkboxes = document.querySelectorAll(".employee-checkbox");

        checkboxes.forEach((checkbox) => {
          checkbox.checked = selectAll.checked;
        });

        updateDeleteButton();
      }

      // Update delete button state and selected count
      function updateDeleteButton() {
        const checkboxes = document.querySelectorAll(
          ".employee-checkbox:checked"
        );
        const deleteBtn = document.getElementById("deleteSelectedBtn");
        const countSpan = document.getElementById("selectedCount");

        if (checkboxes.length > 0) {
          deleteBtn.disabled = false;
          countSpan.innerHTML = `<i class="bi bi-info-circle"></i> ${checkboxes.length} nhân viên đã chọn`;
        } else {
          deleteBtn.disabled = true;
          countSpan.innerHTML = "";
        }

        // Update select all checkbox state
        const allCheckboxes = document.querySelectorAll(".employee-checkbox");
        const selectAllCheckbox = document.getElementById("selectAll");

        if (
          checkboxes.length === allCheckboxes.length &&
          checkboxes.length > 0
        ) {
          selectAllCheckbox.checked = true;
          selectAllCheckbox.indeterminate = false;
        } else if (checkboxes.length > 0) {
          selectAllCheckbox.checked = false;
          selectAllCheckbox.indeterminate = true;
        } else {
          selectAllCheckbox.checked = false;
          selectAllCheckbox.indeterminate = false;
        }
      }

      // Show delete modal for multiple employees
      function showDeleteModal() {
        console.log("showDeleteModal called");
        const checkboxes = document.querySelectorAll(
          ".employee-checkbox:checked"
        );
        selectedEmployees = [];

        checkboxes.forEach((checkbox) => {
          selectedEmployees.push({
            id: checkbox.value,
            name: checkbox.getAttribute("data-name"),
            email: checkbox.getAttribute("data-email"),
            phone: checkbox.getAttribute("data-phone"),
          });
        });

        console.log("Selected employees:", selectedEmployees);

        if (selectedEmployees.length > 0) {
          displayEmployeeList(selectedEmployees);
          showModal();
        }
      }

      // Show delete modal for single employee
      function showDeleteSingleModal(id, name, email, phone) {
        console.log("showDeleteSingleModal called", { id, name, email, phone });
        selectedEmployees = [
          {
            id: id,
            name: name,
            email: email,
            phone: phone,
          },
        ];

        displayEmployeeList(selectedEmployees);
        showModal();
      }

      // Display employee list in modal
      function displayEmployeeList(employees) {
        const employeeListDiv = document.getElementById("employeeList");
        employeeListDiv.innerHTML = "";

        employees.forEach((emp, index) => {
          const empDiv = document.createElement("div");
          empDiv.className = "employee-info-card";
          empDiv.innerHTML = `
            <div class="row">
              <div class="col-md-8">
                <h6 class="mb-2 text-danger">
                  <i class="bi bi-person-fill"></i>
                  Nhân viên #${emp.id}
                </h6>
                <div class="row">
                  <div class="col-sm-4"><strong>Tên:</strong></div>
                  <div class="col-sm-8">${emp.name}</div>
                </div>
                <div class="row">
                  <div class="col-sm-4"><strong>Email:</strong></div>
                  <div class="col-sm-8">${
                    emp.email || '<span class="text-muted">Chưa có</span>'
                  }</div>
                </div>
                <div class="row">
                  <div class="col-sm-4"><strong>Điện thoại:</strong></div>
                  <div class="col-sm-8">${
                    emp.phone || '<span class="text-muted">Chưa có</span>'
                  }</div>
                </div>
              </div>
              <div class="col-md-4 d-flex align-items-center justify-content-center">
                <i class="bi bi-person-x-fill text-danger" style="font-size: 3rem; opacity: 0.3;"></i>
              </div>
            </div>
          `;
          employeeListDiv.appendChild(empDiv);
        });
      }

      // Confirm delete action
      function confirmDelete() {
        console.log("confirmDelete called");
        if (selectedEmployees.length > 0) {
          const employeeIds = selectedEmployees.map((emp) => emp.id);
          console.log("Deleting employee IDs:", employeeIds);

          // Create form and submit
          const form = document.createElement("form");
          form.method = "POST";
          form.action = "/Employee/delete";

          employeeIds.forEach((id) => {
            const input = document.createElement("input");
            input.type = "hidden";
            input.name = "employeeIds";
            input.value = id;
            form.appendChild(input);
          });

          document.body.appendChild(form);

          // Close modal before submit
          closeModal();

          // Show loading notification
          showLoadingToast();

          // Submit form
          form.submit();
        }
      }

      // Show loading toast
      function showLoadingToast() {
        const toastHtml = `
          <div class="toast position-fixed top-0 end-0 m-3" role="alert" aria-live="assertive" aria-atomic="true" id="loadingToast">
            <div class="toast-header bg-info text-white">
              <div class="spinner-border spinner-border-sm me-2" role="status"></div>
              <strong class="me-auto">Đang xử lý</strong>
            </div>
            <div class="toast-body">
              Đang xóa nhân viên, vui lòng đợi...
            </div>
          </div>
        `;

        document.body.insertAdjacentHTML("beforeend", toastHtml);
        const toastElement = document.getElementById("loadingToast");
        const toast = new bootstrap.Toast(toastElement, {
          autohide: false,
        });
        toast.show();
      }
    </script>
  </body>
</html>
