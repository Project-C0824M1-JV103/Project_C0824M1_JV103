<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Nhập kho</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/admin-navbar.css}"/>
    <link rel="stylesheet" th:href="@{/admin-common.css}"/>
    <link rel="stylesheet" th:href="@{/import-storage.css}"/>
</head>
<body>
<div class="container-fluid">
    <div class="row">
        <div th:replace="~{navbar/admin-navbar :: admin-sidebar}"></div>

        <div class="col-md-9 col-lg-10 ms-sm-auto">
            <div class="main-content">
                <div class="header-section">
                    <div class="row align-items-center">
                        <div class="col">
                            <h2 class="mb-1">
                                <i class="fas fa-boxes text-primary me-2"></i>
                                Quản lý nhập kho
                            </h2>
                            <p class="text-muted mb-0">
                                Thêm mới nhập kho
                            </p>
                        </div>
                    </div>
                </div>
                <div class="container">
                    <h4 class="text-center mb-4"><i class="fas fa-clipboard-list"></i> Nhập kho</h4>
                    <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show" role="alert">
                        <span th:text="${errorMessage}"></span>
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                    <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show" role="alert">
                        <span th:text="${successMessage}"></span>
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                    <div class="d-flex justify-content-between mb-3">
                        <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#productModal">Chọn sản phẩm</button>
                        <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addProductModal">Thêm sản phẩm mới</button>
                    </div>
                    <div th:if="${storageImportDTO != null}">
                        <form th:action="@{/storage/create}" th:object="${storageImportDTO}" method="post" id="importForm" enctype="multipart/form-data">
                            <div class="mb-3 row">
                                <div class="col-8">
                                    <label class="form-label">Tên sản phẩm</label>
                                    <input type="text" class="form-control" th:field="*{productName}" readonly>
                                    <div th:if="${#fields.hasErrors('productName')}">
                                        <span th:each="err : ${#fields.errors('productName')}" th:text="${err}" class="text-danger small"></span>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <input type="hidden" th:field="*{productId}" id="productIdInput">
                                    <div th:if="${#fields.hasErrors('productId')}">
                                        <span th:each="err : ${#fields.errors('productId')}" th:text="${err}" class="text-danger small"></span>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3 row">
                                <div class="col-8">
                                    <label class="form-label">Giá nhập (VND)</label>
                                    <input type="text" class="form-control" th:field="*{cost}" id="costInput" autocomplete="off">
                                    <div th:if="${#fields.hasErrors('cost')}">
                                        <span th:each="err : ${#fields.errors('cost')}" th:text="${err}" class="text-danger small"></span>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3 row">
                                <div class="col-8">
                                    <label class="form-label">Số lượng nhập</label>
                                    <input type="number" min="1" class="form-control" th:field="*{importQuantity}">
                                    <div th:if="${#fields.hasErrors('importQuantity')}">
                                        <span th:each="err : ${#fields.errors('importQuantity')}" th:text="${err}" class="text-danger small"></span>
                                    </div>
                                </div>
                                <div class="col-4"></div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Nhà cung cấp</label>
                                <div class="row">
                                    <div class="col-8">
                                        <input type="text" class="form-control" th:field="*{supplierName}" readonly>
                                        <input type="hidden" th:field="*{supplierId}" id="supplierIdInput">
                                        <div th:if="${#fields.hasErrors('supplierId')}">
                                            <span th:each="err : ${#fields.errors('supplierId')}" th:text="${err}" class="text-danger small"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <input type="hidden" name="isNewProduct" value="false">
                            <input type="hidden" name="newProductName">
                            <input type="hidden" name="size">
                            <input type="hidden" name="cameraBack">
                            <input type="hidden" name="cameraFront">
                            <input type="hidden" name="cpu">
                            <input type="hidden" name="memory">
                            <input type="hidden" name="categoryId">
                            <input type="hidden" name="supplierId">

                            <input type="file" name="imageFiles" id="addProductImageFilesHidden" multiple style="display:none">

                            <div class="d-flex justify-content-end gap-2">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save me-1"></i>Lưu vào kho
                                </button>
                                <a th:href="@{/storage/list-import}" class="btn btn-secondary">
                                    <i class="fas fa-times me-1"></i>Quay lại
                                </a>
                            </div>
                        </form>
                    </div>
                    <div th:if="${storageImportDTO == null}" class="alert alert-danger">
                        Lỗi: Không thể tải form nhập kho. Vui lòng thử lại.
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Modal chọn sản phẩm -->
<div class="modal fade" id="productModal" tabindex="-1" aria-labelledby="productModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content" style="max-width: 95vw; width: 120%;">
            <div class="modal-header">
                <h5 class="modal-title" id="productModalLabel">Chọn sản phẩm</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="productSearchForm" class="mb-4" onsubmit="event.preventDefault(); searchProducts();">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="fas fa-mobile-alt"></i>
                                </span>
                                <input type="text" name="productName" class="form-control"
                                       placeholder="Tìm kiếm theo tên sản phẩm..."/>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <button type="button" class="btn btn-primary w-100" onclick="searchProducts()">
                                <i class="fas fa-search"></i> Tìm kiếm
                            </button>
                        </div>
                        <div class="col-md-3">
                            <button type="button" class="btn btn-outline-secondary w-100" onclick="refreshProductList()"
                                    title="Làm mới">
                                <i class="fas fa-sync-alt"></i> Làm mới
                            </button>
                        </div>
                    </div>
                    <input type="hidden" name="page" value="0"/>
                    <input type="hidden" name="size" value="6"/>
                </form>
                <div class="table-responsive">
                    <table class="table table-bordered table-hover align-middle text-nowrap">
                        <thead class="table-light">
                        <tr>
                            <th>STT</th>
                            <th>Tên sản phẩm</th>
                            <th>Giá nhập (VND)</th>
                            <th>Số lượng trong kho</th>
                            <th>CPU</th>
                            <th>Lưu trữ (GB)</th>
                            <th>Chọn</th>
                        </tr>
                        </thead>
                        <tbody id="productTableBody"></tbody>
                    </table>
                </div>
                <div id="productPaginationContainer" class="d-flex justify-content-end align-items-center p-3 border-top mt-3"></div>
            </div>
        </div>
    </div>
</div>
<!-- Modal thêm sản phẩm mới -->
<div class="modal fade" id="addProductModal" tabindex="-1" aria-labelledby="addProductModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0">
                <h4 class="modal-title w-100 text-white text-center m-0" id="addProductModalLabel">
                    <i class="fas fa-plus me-2"></i>Thêm sản phẩm mới
                </h4>
                <button type="button" class="btn-close btn-close-white position-absolute end-0 me-3" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <form id="addProductForm" novalidate>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="d-flex align-items-center gap-2">
                                <label class="form-label mb-0">Tên sản phẩm <span class="required text-danger">*</span></label>
                                <div class="error-container" id="error-productName"></div>
                                </div>
                            <input type="text" name="productName" class="form-control" placeholder="Nhập tên sản phẩm" maxlength="100" required th:value="${productTemp != null ? productTemp.productName : ''}">
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex align-items-center gap-2">
                                <label class="form-label mb-0">Kích thước màn hình (inch)<span class="required text-danger">*</span></label>
                                <div class="error-container" id="error-size"></div>
                                </div>
                            <input type="text" name="size" class="form-control" placeholder="Ví dụ: 6.1" maxlength="50" th:value="${productTemp != null ? productTemp.size : ''}">
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex align-items-center gap-2">
                                <label class="form-label mb-0">Danh mục <span class="required text-danger">*</span></label>
                                <div class="error-container" id="error-categoryId"></div>
                                </div>
                            <select name="categoryId" class="form-select" required>
                                <option value="" disabled th:selected="${productTemp == null || productTemp.categoryId == null}">-- Chọn danh mục --</option>
                                <option th:each="c : ${categorys}" th:value="${c.categoryId}" th:text="${c.categoryName}" th:selected="${productTemp != null and productTemp.categoryId != null and c.categoryId == productTemp.categoryId}"></option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex align-items-center gap-2">
                                <label class="form-label mb-0">Nhà cung cấp <span class="required text-danger">*</span></label>
                                <div class="error-container" id="error-supplierId"></div>
                                </div>
                            <select name="supplierId" class="form-select" required>
                                <option value="" disabled th:selected="${productTemp == null || productTemp.supplierId == null}">-- Chọn nhà cung cấp --</option>
                                <option th:each="s : ${suppliers}" th:value="${s.suplierId}" th:text="${s.suplierName}" th:selected="${productTemp != null and productTemp.supplierId != null and s.suplierId == productTemp.supplierId}"></option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex align-items-center gap-2">
                                <label class="form-label mb-0">Camera sau (MP)<span class="required text-danger">*</span></label>
                                <div class="error-container" id="error-cameraBack"></div>
                                </div>
                            <input type="text" name="cameraBack" class="form-control" placeholder="Ví dụ: 48" maxlength="50" th:value="${productTemp != null ? productTemp.cameraBack : ''}">
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex align-items-center gap-2">
                                <label class="form-label mb-0">Camera trước (MP)<span class="required text-danger">*</span></label>
                                <div class="error-container" id="error-cameraFront"></div>
                                </div>
                            <input type="text" name="cameraFront" class="form-control" placeholder="Ví dụ: 12" maxlength="50" th:value="${productTemp != null ? productTemp.cameraFront : ''}">
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex align-items-center gap-2">
                                <label class="form-label mb-0">CPU <span class="required text-danger">*</span></label>
                                <div class="error-container" id="error-cpu"></div>
                                </div>
                            <input type="text" name="cpu" class="form-control" placeholder="Ví dụ: A15 Bionic" maxlength="50" th:value="${productTemp != null ? productTemp.cpu : ''}">
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex align-items-center gap-2">
                                <label class="form-label mb-0">Bộ nhớ (GB)<span class="required text-danger">*</span></label>
                                <div class="error-container" id="error-memory"></div>
                                </div>
                            <input type="text" name="memory" class="form-control" placeholder="Ví dụ: 128" maxlength="50" th:value="${productTemp != null ? productTemp.memory : ''}">
                            </div>
                        <div class="col-12">
                            <div class="form-group">
                                <label class="form-label">Hình ảnh sản phẩm</label>
                                <div class="image-section">
                                    <!-- Preview Section -->
                                    <div class="image-preview-section">
                                        <div id="addProductImagePreview"></div>
                        </div>
                                    <!-- Upload Section -->
                                    <div class="image-upload-section">
                                        <h6 class="mb-3 text-muted">
                                            <i class="fas fa-cloud-upload-alt me-2"></i>Upload ảnh mới
                                        </h6>
                                        <div class="image-upload-area" id="addProductImageUploadArea">
                                            <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                                            <h6 class="text-muted mb-2">Thêm ảnh sản phẩm</h6>
                                            <p class="text-muted mb-3" id="addProductImageUploadText">
                                                Kéo thả file ảnh vào đây<br/>hoặc click để chọn
                                            </p>
                                            <input type="file" id="addProductImageFiles" name="addProductImageFiles" multiple accept="image/*" class="form-control" style="display: none" />
                                            <button type="button" class="btn btn-primary btn-sm mb-3" onclick="document.getElementById('addProductImageFiles').click()">
                                                <i class="fas fa-plus me-2"></i>Chọn ảnh
                                            </button>
                                            <div class="text-center">
                                                <small class="text-muted">
                                                    <i class="fas fa-info-circle me-1"></i>
                                                    Hỗ trợ: JPG, PNG, GIF<br/>
                                                    Tối đa 5MB mỗi file
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-12 pt-2">
                            <div class="d-flex justify-content-center gap-3">
                                <button type="button" class="btn btn-primary px-4" id="saveNewProductBtn" onclick="saveNewProductTemp()">
                                    <i class="fas fa-save me-1"></i>Lưu sản phẩm
                                </button>
                                <button type="button" class="btn btn-secondary px-4" data-bs-dismiss="modal">
                                    <i class="fas fa-times me-1"></i>Đóng
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    let newProductTemp = null;

    function resetAddProductModal() {
        document.getElementById('addProductForm').reset();
        newProductTemp = null;
    }

    function clearFieldErrors() {
        document.querySelectorAll('#addProductForm .error-container').forEach(div => div.innerHTML = '');
    }

    function saveNewProductTemp() {
        clearFieldErrors();
        const form = document.getElementById('addProductForm');
        const formData = new FormData(form);
        let hasError = false;

        // Validate giống DTO
        const productName = formData.get('productName');
        if (!productName || productName.trim() === '') {
            document.getElementById('error-productName').innerHTML = '<span class="text-danger small">Tên sản phẩm không được để trống</span>';
            hasError = true;
        } else if (productName.length > 100) {
            document.getElementById('error-productName').innerHTML = '<span class="text-danger small">Tên sản phẩm tối đa 100 ký tự</span>';
            hasError = true;
        } else if (!/^[a-zA-Z0-9\s\-_.]+$/.test(productName)) {
            document.getElementById('error-productName').innerHTML = '<span class="text-danger small">Tên sản phẩm không được chứa ký tự đặc biệt</span>';
            hasError = true;
        }

        const size = formData.get('size');
        if (!size || size.trim() === '') {
            document.getElementById('error-size').innerHTML = '<span class="text-danger small">Kích thước màn hình không được để trống</span>';
            hasError = true;
        } else if (size.length > 50) {
            document.getElementById('error-size').innerHTML = '<span class="text-danger small">Kích thước màn hình tối đa 50 ký tự</span>';
            hasError = true;
        } else if (!/^[0-9]+(\.[0-9]+)?$/.test(size)) {
            document.getElementById('error-size').innerHTML = '<span class="text-danger small">Kích thước màn hình chỉ được nhập số</span>';
            hasError = true;
        }

        const cameraBack = formData.get('cameraBack');
        if (!cameraBack || cameraBack.trim() === '') {
            document.getElementById('error-cameraBack').innerHTML = '<span class="text-danger small">Camera sau không được để trống</span>';
            hasError = true;
        } else if (cameraBack.length > 50) {
            document.getElementById('error-cameraBack').innerHTML = '<span class="text-danger small">Camera sau tối đa 50 ký tự</span>';
            hasError = true;
        } else if (!/^[0-9]+$/.test(cameraBack)) {
            document.getElementById('error-cameraBack').innerHTML = '<span class="text-danger small">Camera sau chỉ được nhập số</span>';
            hasError = true;
        }

        const cameraFront = formData.get('cameraFront');
        if (!cameraFront || cameraFront.trim() === '') {
            document.getElementById('error-cameraFront').innerHTML = '<span class="text-danger small">Camera trước không được để trống</span>';
            hasError = true;
        } else if (cameraFront.length > 50) {
            document.getElementById('error-cameraFront').innerHTML = '<span class="text-danger small">Camera trước tối đa 50 ký tự</span>';
            hasError = true;
        } else if (!/^[0-9]+$/.test(cameraFront)) {
            document.getElementById('error-cameraFront').innerHTML = '<span class="text-danger small">Camera trước chỉ được nhập số</span>';
            hasError = true;
        }

        const cpu = formData.get('cpu');
        if (!cpu || cpu.trim() === '') {
            document.getElementById('error-cpu').innerHTML = '<span class="text-danger small">CPU không được để trống</span>';
            hasError = true;
        } else if (cpu.length > 50) {
            document.getElementById('error-cpu').innerHTML = '<span class="text-danger small">CPU tối đa 50 ký tự</span>';
            hasError = true;
        } else if (!/^[a-zA-Z0-9\s\-_.]+$/.test(cpu)) {
            document.getElementById('error-cpu').innerHTML = '<span class="text-danger small">CPU không được chứa ký tự đặc biệt</span>';
            hasError = true;
        }

        const memory = formData.get('memory');
        if (!memory || memory.trim() === '') {
            document.getElementById('error-memory').innerHTML = '<span class="text-danger small">Bộ nhớ không được để trống</span>';
            hasError = true;
        } else if (memory.length > 50) {
            document.getElementById('error-memory').innerHTML = '<span class="text-danger small">Bộ nhớ tối đa 50 ký tự</span>';
            hasError = true;
        } else if (!/^[0-9]+$/.test(memory)) {
            document.getElementById('error-memory').innerHTML = '<span class="text-danger small">Bộ nhớ chỉ được nhập số</span>';
            hasError = true;
        }

        const categoryId = formData.get('categoryId');
        if (!categoryId) {
            document.getElementById('error-categoryId').innerHTML = '<span class="text-danger small">Danh mục không được để trống</span>';
            hasError = true;
        }
        const supplierId = formData.get('supplierId');
        if (!supplierId) {
            document.getElementById('error-supplierId').innerHTML = '<span class="text-danger small">Nhà cung cấp không được để trống</span>';
            hasError = true;
        }

        if (hasError) return;

        // Nếu hợp lệ, lưu vào biến tạm
        newProductTemp = {};
        for (let [key, value] of formData.entries()) {
            newProductTemp[key] = value;
        }
        const supplierSelect = form.querySelector('select[name="supplierId"]');
        const supplierName = supplierSelect.options[supplierSelect.selectedIndex].text;
        newProductTemp['supplierName'] = supplierName;
        // Gán vào form nhập kho chính
        document.querySelector('input[name="productName"]').value = newProductTemp['productName'] || '';
        document.querySelector('input[name="supplierName"]').value = newProductTemp['supplierName'] || '';
        document.querySelector('input[name="supplierId"]').value = newProductTemp['supplierId'] || '';
        document.querySelector('input[name="productId"]').value = '';

        // Đóng modal
        bootstrap.Modal.getInstance(document.getElementById('addProductModal')).hide();
    }

    // Khi submit form nhập kho chính
    document.getElementById('importForm').addEventListener('submit', function (event) {
        // Nếu có sản phẩm mới tạm, gán các trường vào form trước khi submit
        if (newProductTemp) {
            this.querySelector('input[name="isNewProduct"]').value = 'true';
            this.querySelector('input[name="newProductName"]').value = newProductTemp['productName'] || '';
            this.querySelector('input[name="size"]').value = newProductTemp['size'] || '';
            this.querySelector('input[name="cameraBack"]').value = newProductTemp['cameraBack'] || '';
            this.querySelector('input[name="cameraFront"]').value = newProductTemp['cameraFront'] || '';
            this.querySelector('input[name="cpu"]').value = newProductTemp['cpu'] || '';
            this.querySelector('input[name="memory"]').value = newProductTemp['memory'] || '';
            this.querySelector('input[name="categoryId"]').value = newProductTemp['categoryId'] || '';
            this.querySelector('input[name="supplierId"]').value = newProductTemp['supplierId'] || '';
        } else {
            this.querySelector('input[name="isNewProduct"]').value = 'false';
        }
        const costInput = this.querySelector('input[name="cost"]');
        if (costInput) {
            costInput.value = costInput.value.replace(/[^0-9]/g, '');
            if (costInput.value) {
                costInput.value = Number(costInput.value);
            }
        }
        if (typeof addProductSelectedFiles !== 'undefined' && newProductTemp && addProductSelectedFiles.length > 0) {
            const dataTransfer = new DataTransfer();
            addProductSelectedFiles.forEach(file => dataTransfer.items.add(file));
            document.getElementById('addProductImageFilesHidden').files = dataTransfer.files;
        }
    });

    function attachSelectProductEvents() {
        const productButtons = document.querySelectorAll('.btn-select-product');
        productButtons.forEach(button => {
            button.addEventListener('click', function () {
                resetAddProductModal();

                const name = this.getAttribute('data-product-name');
                const cost = this.getAttribute('data-product-cost');
                const productId = this.getAttribute('data-product-id');
                const supplierId = this.getAttribute('data-supplier-id');
                const supplierName = this.getAttribute('data-supplier-name');

                document.querySelector('input[name="productName"]').value = name;
                document.querySelector('input[name="cost"]').value = formatNumber(cost);
                document.querySelector('input[name="productId"]').value = productId;
                document.querySelector('input[name="supplierName"]').value = supplierName;
                document.querySelector('input[name="supplierId"]').value = supplierId;

                const modal = bootstrap.Modal.getInstance(document.getElementById('productModal'));
                if (modal) modal.hide();
            });
        });
    }

    function formatNumber(value) {
        if (!value) return '';
        let num = Number(value.toString().replace(/[^0-9.]/g, ''));
        if (isNaN(num)) return '';
        return num.toLocaleString('en-US');
    }

    const costInput = document.getElementById('costInput');
    if (costInput) {
        costInput.addEventListener('input', function () {
            let val = this.value.replace(/[^0-9]/g, '');
            if (val) {
                this.value = Number(val).toLocaleString('en-US');
            } else {
                this.value = '';
            }
        });
        costInput.addEventListener('blur', function () {
            let val = this.value.replace(/[^0-9]/g, '');
            if (val) {
                this.value = Number(val).toLocaleString('en-US');
            } else {
                this.value = '';
            }
        });
    }

    function renderProductTable(data) {
        const tbody = document.getElementById('productTableBody');
        tbody.innerHTML = data.products.length
            ? data.products.map((p, i) => `
                <tr>
                    <td>${i + 1 + data.pageNumber * data.pageSize}</td>
                    <td>${p.productName}</td>
                    <td>${formatNumber(p.price)}</td>
                    <td>${p.quantity || 0}</td>
                    <td>${p.cpu || ''}</td>
                    <td>${p.memory || ''}</td>
                    <td>
                        <button type="button" class="btn btn-select-product"
                            data-product-name="${p.productName}"
                            data-product-cost="${p.price}"
                            data-product-id="${p.productId}"
                            data-supplier-id="${p.supplierId || ''}"
                            data-supplier-name="${p.supplierName || ''}">
                            <i class="bi bi-check-circle"></i> Chọn
                        </button>
                    </td>
                </tr>
            `).join('')
            : `<tr><td colspan="7" class="text-center">Không tìm thấy sản phẩm nào</td></tr>`;
        attachSelectProductEvents();
        renderProductPagination(data.totalPages, data.pageNumber);
    }

    function fetchProducts(page = 0) {
        const form = document.getElementById('productSearchForm');
        const params = new URLSearchParams(new FormData(form));
        params.set('page', page);
        fetch(`/storage/products/data?${params}`)
            .then(res => res.json())
            .then(renderProductTable)
            .catch(() => alert('Có lỗi khi tải sản phẩm!'));
    }

    function searchProducts() {
        fetchProducts(0);
    }

    function refreshProductList() {
        document.getElementById('productSearchForm').reset();
        fetchProducts(0);
    }

    document.getElementById('productSearchForm').onsubmit = e => { e.preventDefault(); fetchProducts(0); };
    window.changeProductPage = fetchProducts;
    document.getElementById('productModal').addEventListener('show.bs.modal', () => fetchProducts(0));

    function renderProductPagination(totalPages, pageNumber) {
        let html = '';
        if (totalPages > 1) {
            html += '<nav><ul class="pagination pagination-sm mb-0">';
            // Nút First (đầu trang)
            html += `<li class="page-item${pageNumber === 0 ? ' disabled' : ''}">
                <a class="page-link" href="javascript:void(0)" onclick="${pageNumber === 0 ? '' : `changeProductPage(0)`}" title="Trang đầu">
                        <i class="fas fa-angle-double-left"></i>
                    </a>
                </li>`;
            // Nút Previous (trang trước)
            html += `<li class="page-item${pageNumber === 0 ? ' disabled' : ''}">
                <a class="page-link" href="javascript:void(0)" onclick="${pageNumber === 0 ? '' : `changeProductPage(${pageNumber - 1})`}" title="Trang trước">
                    <i class="fas fa-angle-left"></i>
                </a>
                </li>`;
            // Các trang trung gian
            for (let i = 0; i < totalPages; i++) {
                html += `<li class="page-item${i === pageNumber ? ' active' : ''}">
                    <a class="page-link" href="javascript:void(0)" onclick="changeProductPage(${i})">
                        ${i + 1}
                    </a>
                </li>`;
            }
            // Nút Next (trang sau)
            html += `<li class="page-item${pageNumber === totalPages - 1 ? ' disabled' : ''}">
                <a class="page-link" href="javascript:void(0)" onclick="${pageNumber === totalPages - 1 ? '' : `changeProductPage(${pageNumber + 1})`}" title="Trang sau">
                    <i class="fas fa-angle-right"></i>
                </a>
                </li>`;
            // Nút Last (cuối trang)
            html += `<li class="page-item${pageNumber === totalPages - 1 ? ' disabled' : ''}">
                <a class="page-link" href="javascript:void(0)" onclick="${pageNumber === totalPages - 1 ? '' : `changeProductPage(${totalPages - 1})`}" title="Trang cuối">
                    <i class="fas fa-angle-double-right"></i>
                </a>
                    </li>`;
            html += '</ul></nav>';
        }
        document.getElementById('productPaginationContainer').innerHTML = html;
    }

    const ADD_PRODUCT_MAX_IMAGES = 10;
    let addProductSelectedFiles = [];

    document.getElementById('addProductImageFiles').addEventListener('change', function(e) {
        const files = Array.from(e.target.files);
        const validation = addProductValidateNewImages(files);
        if (validation.error) {
            alert(validation.error);
            e.target.value = '';
            return;
        }
        files.forEach(file => addProductSelectedFiles.push(file));
        addProductUpdatePreview();
        e.target.value = '';
    });

    function addProductValidateNewImages(newFiles) {
        const totalCount = addProductSelectedFiles.length + newFiles.length;
        if (totalCount > ADD_PRODUCT_MAX_IMAGES) {
            return { error: `Tổng số ảnh không được vượt quá ${ADD_PRODUCT_MAX_IMAGES} ảnh.` };
        }
        const selectedNames = addProductSelectedFiles.map(f => f.name.toLowerCase());
        const newNames = [];
        for (let i = 0; i < newFiles.length; i++) {
            const fileName = newFiles[i].name.toLowerCase();
            if (selectedNames.includes(fileName)) {
                return { error: `Ảnh "${newFiles[i].name}" đã được chọn trước đó.` };
            }
            if (newNames.includes(fileName)) {
                return { error: `Bạn đang chọn ảnh "${newFiles[i].name}" nhiều lần.` };
            }
            newNames.push(fileName);
            if (newFiles[i].size > 5 * 1024 * 1024) {
                return { error: `Ảnh "${newFiles[i].name}" có kích thước quá lớn (tối đa 5MB).` };
            }
            const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif'];
            if (!validTypes.includes(newFiles[i].type)) {
                return { error: `Ảnh "${newFiles[i].name}" không đúng định dạng. Chỉ chấp nhận JPG, PNG, GIF.` };
            }
        }
        return { error: null };
    }

    function addProductUpdatePreview() {
        const preview = document.getElementById('addProductImagePreview');
        preview.innerHTML = '';
        if (addProductSelectedFiles.length > 0) {
            const title = document.createElement('h6');
            title.textContent = 'Ảnh đã chọn:';
            title.style.marginTop = '15px';
            title.style.marginBottom = '15px';
            preview.appendChild(title);
            addProductSelectedFiles.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const imgDiv = document.createElement('div');
                    imgDiv.className = 'image-preview';
                    imgDiv.setAttribute('data-file-index', index);
                    imgDiv.innerHTML = `
                        <img src="${e.target.result}" alt="New Image" />
                        <button type="button" class="btn-delete" onclick="addProductRemoveFile(${index})" title="Xóa ảnh này">
                          <i class="fas fa-times"></i>
                        </button>
                    `;
                    preview.appendChild(imgDiv);
                };
                reader.readAsDataURL(file);
            });
            document.getElementById('addProductImageUploadText').textContent = `Đã chọn ${addProductSelectedFiles.length} ảnh`;
            } else {
            document.getElementById('addProductImageUploadText').textContent = 'Kéo thả file ảnh vào đây hoặc click để chọn';
        }
    }

    function addProductRemoveFile(index) {
        if (confirm('Xóa ảnh này?')) {
            addProductSelectedFiles.splice(index, 1);
            addProductUpdatePreview();
        }
    }

    const addProductUploadArea = document.getElementById('addProductImageUploadArea');
    addProductUploadArea.addEventListener('dragover', function(e) {
        e.preventDefault();
        this.style.backgroundColor = '#f0f2ff';
        this.style.borderColor = '#667eea';
    });
    addProductUploadArea.addEventListener('dragleave', function(e) {
        e.preventDefault();
        this.style.backgroundColor = '#f8f9fa';
        this.style.borderColor = '#dee2e6';
    });
    addProductUploadArea.addEventListener('drop', function(e) {
        e.preventDefault();
        this.style.backgroundColor = '#f8f9fa';
        this.style.borderColor = '#dee2e6';
        const files = Array.from(e.dataTransfer.files);
        const validation = addProductValidateNewImages(files);
        if (validation.error) {
            alert(validation.error);
            return;
        }
        files.forEach(file => addProductSelectedFiles.push(file));
        addProductUpdatePreview();
    });
</script>
<script th:if="${showAddProductModal}">
    var addProductModal = new bootstrap.Modal(document.getElementById('addProductModal'));
    addProductModal.show();
</script>
</body>
</html>